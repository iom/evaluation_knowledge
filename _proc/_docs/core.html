<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Workflow Description – evaluation_knowledge</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-fad5ab29a14bbe0a7a7d29177f3f13bb.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Workflow Description – evaluation_knowledge">
<meta property="og:description" content="A module to turn Evaluation Reports into AI knowledge">
<meta property="og:site_name" content="evaluation_knowledge">
<meta name="twitter:title" content="Workflow Description – evaluation_knowledge">
<meta name="twitter:description" content="A module to turn Evaluation Reports into AI knowledge">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">evaluation_knowledge</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./core.html">Workflow Description</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">AI-Assisted Evaluation Evidence Mapping</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Workflow Description</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a>
  <ul class="collapse">
  <li><a href="#create-a-virtual-environment" id="toc-create-a-virtual-environment" class="nav-link" data-scroll-target="#create-a-virtual-environment">Create a Virtual Environment</a></li>
  <li><a href="#required-python-modules" id="toc-required-python-modules" class="nav-link" data-scroll-target="#required-python-modules">Required Python Modules</a></li>
  <li><a href="#initialise-llm-api" id="toc-initialise-llm-api" class="nav-link" data-scroll-target="#initialise-llm-api">Initialise LLM API</a></li>
  <li><a href="#load-pdf-library-and-strategic-results-framework" id="toc-load-pdf-library-and-strategic-results-framework" class="nav-link" data-scroll-target="#load-pdf-library-and-strategic-results-framework">Load PDF library and Strategic Results Framework</a></li>
  <li><a href="#library_evaluations" id="toc-library_evaluations" class="nav-link" data-scroll-target="#library_evaluations">library_evaluations</a></li>
  <li><a href="#load_iom_framework" id="toc-load_iom_framework" class="nav-link" data-scroll-target="#load_iom_framework">load_iom_framework</a></li>
  </ul></li>
  <li><a href="#step-1-building-the-knowledge-base" id="toc-step-1-building-the-knowledge-base" class="nav-link" data-scroll-target="#step-1-building-the-knowledge-base">Step 1: Building the Knowledge Base</a>
  <ul class="collapse">
  <li><a href="#initialize-lancedb-vector-database" id="toc-initialize-lancedb-vector-database" class="nav-link" data-scroll-target="#initialize-lancedb-vector-database">Initialize LanceDB Vector Database</a></li>
  <li><a href="#load_evaluations" id="toc-load_evaluations" class="nav-link" data-scroll-target="#load_evaluations">load_evaluations</a></li>
  <li><a href="#generate_id" id="toc-generate_id" class="nav-link" data-scroll-target="#generate_id">generate_id</a></li>
  <li><a href="#force_delete_directory" id="toc-force_delete_directory" class="nav-link" data-scroll-target="#force_delete_directory">force_delete_directory</a></li>
  <li><a href="#initialise_knowledge_base" id="toc-initialise_knowledge_base" class="nav-link" data-scroll-target="#initialise_knowledge_base">initialise_knowledge_base</a></li>
  <li><a href="#safe_get" id="toc-safe_get" class="nav-link" data-scroll-target="#safe_get">safe_get</a></li>
  <li><a href="#download-and-prepare-all-the-files" id="toc-download-and-prepare-all-the-files" class="nav-link" data-scroll-target="#download-and-prepare-all-the-files">Download and prepare all the files</a></li>
  <li><a href="#download_documents" id="toc-download_documents" class="nav-link" data-scroll-target="#download_documents">download_documents</a></li>
  <li><a href="#convert_file_to_pdf" id="toc-convert_file_to_pdf" class="nav-link" data-scroll-target="#convert_file_to_pdf">convert_file_to_pdf</a></li>
  <li><a href="#find_libreoffice_exec" id="toc-find_libreoffice_exec" class="nav-link" data-scroll-target="#find_libreoffice_exec">find_libreoffice_exec</a></li>
  <li><a href="#now-load-file-content-in-the-vector-db-chunk-and-embedd" id="toc-now-load-file-content-in-the-vector-db-chunk-and-embedd" class="nav-link" data-scroll-target="#now-load-file-content-in-the-vector-db-chunk-and-embedd">Now load file content in the vector DB, chunk and embedd</a></li>
  <li><a href="#process_documents_to_chunks" id="toc-process_documents_to_chunks" class="nav-link" data-scroll-target="#process_documents_to_chunks">process_documents_to_chunks</a></li>
  <li><a href="#check_chunk_status" id="toc-check_chunk_status" class="nav-link" data-scroll-target="#check_chunk_status">check_chunk_status</a></li>
  <li><a href="#generating-ai-enhanced-metadata" id="toc-generating-ai-enhanced-metadata" class="nav-link" data-scroll-target="#generating-ai-enhanced-metadata">Generating AI-Enhanced metadata</a></li>
  <li><a href="#get_context_for_eval" id="toc-get_context_for_eval" class="nav-link" data-scroll-target="#get_context_for_eval">get_context_for_eval</a></li>
  <li><a href="#call_llm_with_retries" id="toc-call_llm_with_retries" class="nav-link" data-scroll-target="#call_llm_with_retries">call_llm_with_retries</a></li>
  <li><a href="#safe_join" id="toc-safe_join" class="nav-link" data-scroll-target="#safe_join">safe_join</a></li>
  <li><a href="#clean_json" id="toc-clean_json" class="nav-link" data-scroll-target="#clean_json">clean_json</a></li>
  <li><a href="#generate_metadata_for_evaluation_metadata_descriptive" id="toc-generate_metadata_for_evaluation_metadata_descriptive" class="nav-link" data-scroll-target="#generate_metadata_for_evaluation_metadata_descriptive">generate_metadata_for_evaluation_metadata_descriptive</a></li>
  <li><a href="#generate_metadata_for_evaluation_metadata_methodo" id="toc-generate_metadata_for_evaluation_metadata_methodo" class="nav-link" data-scroll-target="#generate_metadata_for_evaluation_metadata_methodo">generate_metadata_for_evaluation_metadata_methodo</a></li>
  <li><a href="#generate_metadata_for_evaluation_metadata_evidence" id="toc-generate_metadata_for_evaluation_metadata_evidence" class="nav-link" data-scroll-target="#generate_metadata_for_evaluation_metadata_evidence">generate_metadata_for_evaluation_metadata_evidence</a></li>
  <li><a href="#generate_evaluation_metadata" id="toc-generate_evaluation_metadata" class="nav-link" data-scroll-target="#generate_evaluation_metadata">generate_evaluation_metadata</a></li>
  </ul></li>
  <li><a href="#step-2-structured-information-extraction" id="toc-step-2-structured-information-extraction" class="nav-link" data-scroll-target="#step-2-structured-information-extraction">Step 2: Structured Information Extraction</a>
  <ul class="collapse">
  <li><a href="#standard-questions" id="toc-standard-questions" class="nav-link" data-scroll-target="#standard-questions">Standard Questions</a></li>
  <li><a href="#qa-extraction" id="toc-qa-extraction" class="nav-link" data-scroll-target="#qa-extraction">Q&amp;A Extraction</a></li>
  <li><a href="#hybrid-search-in-lancedb" id="toc-hybrid-search-in-lancedb" class="nav-link" data-scroll-target="#hybrid-search-in-lancedb">Hybrid Search in LanceDB</a></li>
  </ul></li>
  <li><a href="#step-3-cross-evaluation-analysis" id="toc-step-3-cross-evaluation-analysis" class="nav-link" data-scroll-target="#step-3-cross-evaluation-analysis">Step 3: Cross-Evaluation Analysis</a></li>
  <li><a href="#step-4-generate-actionable-and-generalizable-insights" id="toc-step-4-generate-actionable-and-generalizable-insights" class="nav-link" data-scroll-target="#step-4-generate-actionable-and-generalizable-insights">Step 4: Generate Actionable and Generalizable Insights</a></li>
  <li><a href="#step-5-identify-patterns-and-gaps" id="toc-step-5-identify-patterns-and-gaps" class="nav-link" data-scroll-target="#step-5-identify-patterns-and-gaps">Step 5: Identify Patterns and Gaps</a></li>
  <li><a href="#conclusions---and-potential-extension" id="toc-conclusions---and-potential-extension" class="nav-link" data-scroll-target="#conclusions---and-potential-extension">Conclusions - and potential extension…</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/iom/evaluation_knowledge/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="core.html.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Workflow Description</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This notebook implements an evidence mapping system with:</p>
<ul>
<li><p>Batch processing for scalability</p></li>
<li><p>Robust error handling and retries</p></li>
<li><p>Embedding caching</p></li>
<li><p>Hybrid search (vector + full-text)</p></li>
<li><p>Local LanceDB deployment</p></li>
</ul>
<p>we can follow these steps:</p>
<ul>
<li>Load the JSON file containing the URLs of the PDF reports.</li>
<li>Load the Excel file describing the IOM Results Framework.</li>
<li>Download and process the PDF reports to extract text.</li>
<li>Integrate the extracted text with the IOM Results Framework.</li>
<li>Generate embeddings and store them in LanceDB.</li>
</ul>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<section id="create-a-virtual-environment" class="level3">
<h3 class="anchored" data-anchor-id="create-a-virtual-environment">Create a Virtual Environment</h3>
<p>To ensure a clean and isolated environment for this project, we will create a virtual environment using Python’s <code>venv</code> module. This will help manage dependencies and avoid conflicts with other projects.</p>
<pre class="{bash}"><code>#| eval: false
python -m venv .venv</code></pre>
<p>Then, activate the virtual environment:</p>
<pre class="{bash}"><code>#| eval: false
.\.venv\Scripts\activate</code></pre>
<p>Then, configure visual Studio Code to use the virtual environment: Open the Command Palette using the shortcut <code>Ctrl+Shift+P</code> and type <code>Jupyter: Select Interpreter</code> and select the interpreter that corresponds to your newly created virtual environment: <code>('venv': venv)</code>.</p>
</section>
<section id="required-python-modules" class="level3">
<h3 class="anchored" data-anchor-id="required-python-modules">Required Python Modules</h3>
<p>Once this environment selected as a kernel to run the notebook, we can install the required python modules the rest of the process:</p>
<pre class="{python}"><code>%pip install openai  lancedb pyarrow pandas numpy matplotlib seaborn plotly pymupdf requests tqdm tenacity ipython dotenv langchain langchain-community langchain_openai  ipywidgets openpyxl  filetype</code></pre>
<p>then Restart the jupyter kernel for this notebook</p>
<pre class="{python}"><code>#| eval: false
%reset -f</code></pre>
</section>
<section id="initialise-llm-api" class="level3">
<h3 class="anchored" data-anchor-id="initialise-llm-api">Initialise LLM API</h3>
<div id="llmapi" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load environment variables</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_openai <span class="im">import</span> AzureChatOpenAI </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize LLM with higher temperature for creative question generation</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>llm_creative <span class="op">=</span> AzureChatOpenAI(</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    deployment_name<span class="op">=</span>os.getenv(<span class="st">"AZURE_DEPLOYMENT_NAME"</span>),</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.getenv(<span class="st">"AZURE_OPENAI_API_KEY"</span>),</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    azure_endpoint<span class="op">=</span>os.getenv(<span class="st">"AZURE_OPENAI_ENDPOINT"</span>),</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    api_version<span class="op">=</span>os.getenv(<span class="st">"AZURE_OPENAI_API_VERSION"</span>),</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    temperature<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span><span class="dv">500</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>llm_accurate <span class="op">=</span> AzureChatOpenAI(</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    deployment_name<span class="op">=</span>os.getenv(<span class="st">"AZURE_DEPLOYMENT_NAME"</span>),</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.getenv(<span class="st">"AZURE_OPENAI_API_KEY"</span>),</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    azure_endpoint<span class="op">=</span>os.getenv(<span class="st">"AZURE_OPENAI_ENDPOINT"</span>),</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    api_version<span class="op">=</span>os.getenv(<span class="st">"AZURE_OPENAI_API_VERSION"</span>),</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    temperature<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span><span class="dv">1000</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-pdf-library-and-strategic-results-framework" class="level3">
<h3 class="anchored" data-anchor-id="load-pdf-library-and-strategic-results-framework">Load PDF library and Strategic Results Framework</h3>
<p>The library</p>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L18" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="library_evaluations" class="level3">
<h3 class="anchored" data-anchor-id="library_evaluations">library_evaluations</h3>
<blockquote class="blockquote">
<pre><code> library_evaluations (file_path, json_path)</code></pre>
</blockquote>
<div id="library_evaluations" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openpyxl</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> library_evaluations(file_path,json_path):</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the Excel file</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_excel(file_path, sheet_name<span class="op">=</span><span class="st">'extract from 2005 to Aug 2024'</span>, engine<span class="op">=</span><span class="st">'openpyxl'</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter evaluations from 2005 to August 2024</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    filtered_df <span class="op">=</span> df </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a nested structure</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    evaluations <span class="op">=</span> []</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> filtered_df.iterrows():</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        evaluation <span class="op">=</span> {</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Title"</span>: row[<span class="st">"Title"</span>],</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Year"</span>: <span class="bu">str</span>(row[<span class="st">"Year"</span>]),</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Author"</span>: row[<span class="st">"Author"</span>],</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Best Practices or Lessons Learnt"</span>: row[<span class="st">"Best Practicesor Lessons Learnt"</span>],</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Date of Publication"</span>: <span class="bu">str</span>(row[<span class="st">"Date of Publication"</span>]),</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Donor"</span>: row[<span class="st">"Donor"</span>],</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Evaluation Brief"</span>: row[<span class="st">"Evaluation Brief"</span>],</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Evaluation Commissioner"</span>: row[<span class="st">"Evaluation Commissioner"</span>],</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Evaluation Coverage"</span>: row[<span class="st">"Evaluation Coverage"</span>],</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Evaluation Period From Date"</span>: <span class="bu">str</span>(row[<span class="st">"Evaluation Period From Date"</span>]),</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Evaluation Period To Date"</span>: <span class="bu">str</span>(row[<span class="st">"Evaluation Period To Date"</span>]),</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Executive Summary"</span>: row[<span class="st">"Executive Summary"</span>],</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">"External Version of the Report"</span>: row[<span class="st">"External Version of the Report"</span>],</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Languages"</span>: row[<span class="st">"Languages"</span>],</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Migration Thematic Areas"</span>: row[<span class="st">"Migration Thematic Areas"</span>],</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Name of Project(s) Being Evaluated"</span>: row[<span class="st">"Name of Project(s) Being Evaluated"</span>],</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Number of Pages Excluding annexes"</span>: row[<span class="st">"Number of Pages Excluding annexes"</span>],</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Other Documents Included"</span>: row[<span class="st">"Other Documents Included"</span>],</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Project Code"</span>: row[<span class="st">"Project Code"</span>],</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Countries Covered"</span>: [country.strip() <span class="cf">for</span> country <span class="kw">in</span> <span class="bu">str</span>(row[<span class="st">"Countries Covered"</span>]).split(<span class="st">","</span>)],</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Regions Covered"</span>: row[<span class="st">"Regions Covered"</span>],</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Relevant Crosscutting Themes"</span>: row[<span class="st">"Relevant Crosscutting Themes"</span>],</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Report Published"</span>: row[<span class="st">"Report Published"</span>],</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Terms of Reference"</span>: row[<span class="st">"Terms of Reference"</span>],</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Type of Evaluation Scope"</span>: row[<span class="st">"Type of Evaluation Scope"</span>],</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Type of Evaluation Timing"</span>: row[<span class="st">"Type of Evaluation Timing"</span>],</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Type of Evaluator"</span>: row[<span class="st">"Type of Evaluator"</span>],</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Level of Evaluation"</span>: row[<span class="st">"Level of Evaluation"</span>],</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Documents"</span>: []</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Split the document-related fields by comma and create a list of dictionaries</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>        document_subtypes <span class="op">=</span> <span class="bu">str</span>(row[<span class="st">"Document Subtype"</span>]).split(<span class="st">", "</span>)</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>        file_urls <span class="op">=</span> <span class="bu">str</span>(row[<span class="st">"File URL"</span>]).split(<span class="st">", "</span>)</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>        file_descriptions <span class="op">=</span> <span class="bu">str</span>(row[<span class="st">"File description"</span>]).split(<span class="st">", "</span>)</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> subtype, url, description <span class="kw">in</span> <span class="bu">zip</span>(document_subtypes, file_urls, file_descriptions):</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>            document <span class="op">=</span> {</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Document Subtype"</span>: subtype,</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>                <span class="st">"File URL"</span>: url,</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>                <span class="st">"File description"</span>: description</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>            evaluation[<span class="st">"Documents"</span>].append(document)</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>        evaluations.append(evaluation)</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">## dump data</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(json_path, <span class="st">'w'</span>) <span class="im">as</span> json_file:</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>        json.dump(evaluations, json_file, indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> evaluations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-8" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>library <span class="op">=</span>library_evaluations(<span class="st">"reference/Evaluation_repository.xlsx"</span>,<span class="st">"reference/Evaluation_repository.json"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now the framework</p>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L88" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="load_iom_framework" class="level3">
<h3 class="anchored" data-anchor-id="load_iom_framework">load_iom_framework</h3>
<blockquote class="blockquote">
<pre><code> load_iom_framework (excel_path:str)</code></pre>
</blockquote>
<p><em>Load and validate IOM framework</em></p>
<div id="load_iom_framework" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openpyxl</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_iom_framework(excel_path: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Load and validate IOM framework"""</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_excel(excel_path)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validate expected columns</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    required_columns <span class="op">=</span> [<span class="st">'Objective'</span>, <span class="st">'Outcome'</span>, <span class="st">'Indicator'</span>]</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> required_columns:</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> col <span class="kw">in</span> df.columns, <span class="ss">f"Framework missing required column: </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-12" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>framework<span class="op">=</span> load_iom_framework(<span class="st">"reference/Strategic_Result_Framework.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="step-1-building-the-knowledge-base" class="level2">
<h2 class="anchored" data-anchor-id="step-1-building-the-knowledge-base">Step 1: Building the Knowledge Base</h2>
<p>So we have a collection of Evaluation documents. We have metadata for each Evaluation. For each evaluation, we have multiple documents (The evaluation report itslef, plus in some case: a summary brief, annexes, etc.)</p>
<p>See an example below</p>
<div id="cell-14" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>[</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Title"</span>: <span class="st">"Finale Internal Evluation: ENHANCING THE CAPACITY TO MAINSTREAM ENVIRONMENT AND CLIMATE CHANGE WITHIN WIDER FRAMEWORK OF MIGRATION MANAGEMENT IN WEST AND CENTRAL AFRICA"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Year"</span>: <span class="st">"2022"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Author"</span>: <span class="st">"Abderrahim El Moulat"</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Best Practices or Lessons Learnt"</span>: <span class="st">"Yes"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Date of Publication"</span>: <span class="st">"2022-06-22 00:00:00"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Donor"</span>: <span class="st">"IOM Development Fund"</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Evaluation Brief"</span>: <span class="st">"Yes"</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Evaluation Commissioner"</span>: <span class="st">"Donor, IOM"</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Evaluation Coverage"</span>: <span class="st">"Country"</span>,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Evaluation Period From Date"</span>: <span class="st">"nan"</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Evaluation Period To Date"</span>: <span class="st">"NaT"</span>,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Executive Summary"</span>: <span class="st">"Yes"</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"External Version of the Report"</span>: <span class="st">"No"</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Languages"</span>: <span class="st">"English"</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Migration Thematic Areas"</span>: <span class="st">"Migration and climate change"</span>,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Name of Project(s) Being Evaluated"</span>: NaN,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Number of Pages Excluding annexes"</span>: <span class="fl">20.0</span>,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Other Documents Included"</span>: NaN,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Project Code"</span>: <span class="st">"NC.0030"</span>,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Countries Covered"</span>: [</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Senegal"</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Regions Covered"</span>: <span class="st">"RO Dakar"</span>,</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Relevant Crosscutting Themes"</span>: <span class="st">"Gender"</span>,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Report Published"</span>: <span class="st">"Yes"</span>,</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Terms of Reference"</span>: <span class="st">"No"</span>,</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Type of Evaluation Scope"</span>: <span class="st">"Programme/Project"</span>,</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Type of Evaluation Timing"</span>: <span class="st">"Ex-post (after the end of the project/programme)"</span>,</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Type of Evaluator"</span>: <span class="st">"Internal"</span>,</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Level of Evaluation"</span>: <span class="st">"Decentralized"</span>,</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Documents"</span>: [</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Document Subtype"</span>: <span class="st">"Evaluation brief"</span>,</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>                <span class="st">"File URL"</span>: <span class="st">"https://evaluation.iom.int/sites/g/files/tmzbdl151/files/docs/resources/Internal</span><span class="sc">%20E</span><span class="st">valuation_NC0030_JUNE_2022_FINAL_Abderrahim</span><span class="sc">%20E</span><span class="st">L%20MOULAT_0.pdf"</span>,</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>                <span class="st">"File description"</span>: <span class="st">"Evaluation Brief"</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Document Subtype"</span>: <span class="st">"Evaluation report"</span>,</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>                <span class="st">"File URL"</span>: <span class="st">"https://evaluation.iom.int/sites/g/files/tmzbdl151/files/docs/resources/NC0030_Evaluation%20Brief_June%202022_Abderrahim</span><span class="sc">%20E</span><span class="st">L%20MOULAT.pdf"</span>,</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">"File description"</span>: <span class="st">"Evaluation Report"</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Title"</span>: <span class="st">"Local Authorities Network for Migration and Development"</span>,</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Year"</span>: <span class="st">"2022"</span>,</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Author"</span>: <span class="st">"Action Research for CO-development (ARCO)"</span>,</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Best Practices or Lessons Learnt"</span>: <span class="st">"No"</span>,</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Date of Publication"</span>: <span class="st">"2022-02-01 00:00:00"</span>,</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Donor"</span>: <span class="st">"Government of Italy"</span>,</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Evaluation Brief"</span>: <span class="st">"No"</span>,</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Evaluation Commissioner"</span>: <span class="st">"IOM"</span>,</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Evaluation Coverage"</span>: <span class="st">"Multi-country"</span>,</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Evaluation Period From Date"</span>: <span class="st">"2020-07-06 00:00:00"</span>,</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Evaluation Period To Date"</span>: <span class="st">"2021-07-31 00:00:00"</span>,</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Executive Summary"</span>: <span class="st">"Yes"</span>,</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">"External Version of the Report"</span>: <span class="st">"No"</span>,</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Languages"</span>: <span class="st">"English"</span>,</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Migration Thematic Areas"</span>: <span class="st">"Migration and Development - diaspora"</span>,</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Name of Project(s) Being Evaluated"</span>: NaN,</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Number of Pages Excluding annexes"</span>: <span class="fl">37.0</span>,</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Other Documents Included"</span>: NaN,</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Project Code"</span>: <span class="st">"MD.0003"</span>,</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Countries Covered"</span>: [</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Albania"</span>,</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Italy"</span></span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Regions Covered"</span>: <span class="st">"RO Brussels"</span>,</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Relevant Crosscutting Themes"</span>: <span class="st">"Gender, Rights-based approach"</span>,</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Report Published"</span>: <span class="st">"No"</span>,</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Terms of Reference"</span>: <span class="st">"Yes"</span>,</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Type of Evaluation Scope"</span>: <span class="st">"Programme/Project"</span>,</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Type of Evaluation Timing"</span>: <span class="st">"Final (at the end of the project/programme)"</span>,</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Type of Evaluator"</span>: <span class="st">"External"</span>,</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Level of Evaluation"</span>: <span class="st">"Decentralized"</span>,</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Documents"</span>: [</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Document Subtype"</span>: <span class="st">"Evaluation report"</span>,</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>                <span class="st">"File URL"</span>: <span class="st">"https://evaluation.iom.int/sites/g/files/tmzbdl151/files/docs/resources/Evaluation%20Brief_ARCO_Shiraz%20JERBI.pdF"</span>,</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>                <span class="st">"File description"</span>: <span class="st">"Evaluation Report "</span></span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Document Subtype"</span>: <span class="st">"Evaluation brief"</span>,</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>                <span class="st">"File URL"</span>: <span class="st">"https://evaluation.iom.int/sites/g/files/tmzbdl151/files/docs/resources/Final</span><span class="sc">%20e</span><span class="st">valuation</span><span class="sc">%20r</span><span class="st">eport_ARCO_Shiraz%20JERBI_1.pdf"</span>,</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>                <span class="st">"File description"</span>: <span class="st">"Evaluation Brief"</span></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Document Subtype"</span>: <span class="st">"Management response"</span>,</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>                <span class="st">"File URL"</span>: <span class="st">"https://evaluation.iom.int/sites/g/files/tmzbdl151/files/docs/resources/Management%20Response%20Matrix_ARCO_Shiraz%20JERBI.pdf"</span>,</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>                <span class="st">"File description"</span>: <span class="st">"Management Response"</span></span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Workflow Overview</p>
<ol type="1">
<li>Load external metadata for one evaluations as per json file.</li>
<li>Then for each evaluation, download the file, convert it to PDF (in case it’s a word, excel or ppt), and load text for each document.</li>
<li>Then implement a <a href="https://isaacflath.com/blog/blog_post?fpath=posts%2F2025-04-08-LateChunking.ipynb">late chunking that can solve the lost context problem</a> and insert in chunk table, enabling <a href="https://docs.lancedb.com/core/hybrid-search">Hybrid Search capability</a> so that search can be made based on both key words and similirarity.</li>
<li>Create additional metadata for both documents and for evaluation using an LLM call. the additional metadata shall help to define an asesssment of the “evidence strenght”. The metadata to be created are - evaluation type (formative, summative, impact), Methodology, study design, sample size, and data collection techniques</li>
</ol>
<section id="initialize-lancedb-vector-database" class="level3">
<h3 class="anchored" data-anchor-id="initialize-lancedb-vector-database">Initialize LanceDB Vector Database</h3>
<p>The database includes 23 tables:</p>
<p><strong>1. Evaluations Table</strong> Each row represents a unique evaluation with the following fields:</p>
<ul>
<li>evaluation_id (unique identifier)</li>
<li>title</li>
<li>author</li>
<li>practice_or_lessons</li>
<li>donor</li>
<li>is_brief</li>
<li>commissioner</li>
<li>coverage</li>
<li>countries</li>
<li>from_date</li>
<li>to_date</li>
<li>has_summary</li>
<li>external_version</li>
<li>language</li>
<li>thematic_area</li>
<li>name_project</li>
<li>project_code</li>
<li>evaluation_scope</li>
<li>evaluation_timing</li>
<li>evaluation_level</li>
<li>evaluator_type</li>
<li>theme</li>
<li>cross_cutting</li>
</ul>
<p>additional variable will be generated through an LLM prompt on the entire evaluation content</p>
<ul>
<li>short_title</li>
<li>summary</li>
<li>population (PICO model)</li>
<li>intervention (PICO model)</li>
<li>comparator (PICO model)</li>
<li>outcome (PICO model)</li>
<li>methodology</li>
<li>study_type</li>
<li>study_design</li>
<li>sample_size</li>
<li>data_collection_techniques</li>
<li>evidence_strength</li>
<li>limitations</li>
</ul>
<p><strong>2. Documents Table</strong></p>
<p>Each row represents a PDF file linked to an evaluation:</p>
<ul>
<li>document_id: Primary key ID of the original PDF</li>
<li>evaluation_id: foreign key to link to the evaluation</li>
<li>document_subtype: from the original metadata</li>
<li>document_url: from the original metadata</li>
<li>document_name: from the original metadata</li>
<li>document_tite: document type as reviewed by the LLM</li>
<li>document_type_infer: document type as reviewed by the LLM</li>
<li>document_processed: boolean to confirm it is done</li>
</ul>
<p><strong>3. Chunk Table</strong> * chunk_id: Primary key<br>
* evaluation_id: foreign key to link to the evaluation * document_id: ID of the original file * document_page: for proper referencing of any further information retrieval * chunk_index: order of the chunk in the document * text: the chunked content * embedding (for hybrid search)</p>
<p>Let’s start by loading the library from json…</p>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L104" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="load_evaluations" class="level3">
<h3 class="anchored" data-anchor-id="load_evaluations">load_evaluations</h3>
<blockquote class="blockquote">
<pre><code> load_evaluations (json_path:str)</code></pre>
</blockquote>
<p>*Load evaluation data from a JSON file</p>
<p>Args: json_path: Path to the JSON file containing evaluation data</p>
<p>Returns: List of evaluation dictionaries*</p>
<div id="load_evaluations" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict, Optional <span class="co"># Type hinting</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_evaluations(json_path: <span class="bu">str</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Load evaluation data from a JSON file</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">        json_path: Path to the JSON file containing evaluation data</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">        List of evaluation dictionaries</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(json_path, <span class="st">'r'</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>) <span class="im">as</span> f:</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> json.load(f)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle both single evaluation and list of evaluations</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(data, <span class="bu">dict</span>):</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [data]</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">isinstance</span>(data, <span class="bu">list</span>):</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> data</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Invalid JSON structure - expected object or array"</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> json.JSONDecodeError <span class="im">as</span> e:</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error decoding JSON file </span><span class="sc">{</span>json_path<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error loading evaluation data: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Load a small subset for testing..</p>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load your   metadata</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">#evaluation_data =  load_evaluations("reference/Evaluation_repository_test.json")</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>evaluation_data <span class="op">=</span>  load_evaluations(<span class="st">"reference/Evaluation_repository.json"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Attribute name is: </span><span class="sc">{</span>evaluation_data<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">type</span>(evaluation_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Id Generation</p>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L136" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="generate_id" class="level3">
<h3 class="anchored" data-anchor-id="generate_id">generate_id</h3>
<blockquote class="blockquote">
<pre><code> generate_id (text:str)</code></pre>
</blockquote>
<p><em>Generate a deterministic ID from text</em></p>
<div id="generate_id" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hashlib</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_id(text: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate a deterministic ID from text"""</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hashlib.md5(text.encode()).hexdigest()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-24" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>eval_id <span class="op">=</span> generate_id( <span class="st">"aaa"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>({eval_id})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L144" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="force_delete_directory" class="level3">
<h3 class="anchored" data-anchor-id="force_delete_directory">force_delete_directory</h3>
<blockquote class="blockquote">
<pre><code> force_delete_directory (path, max_retries=3, delay=1)</code></pre>
</blockquote>
<p><em>Robust directory deletion with retries and delay</em></p>
<div id="force_delete_directory" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> force_delete_directory(path, max_retries<span class="op">=</span><span class="dv">3</span>, delay<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Robust directory deletion with retries and delay"""</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(max_retries):</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> os.path.exists(path):</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                shutil.rmtree(path)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> attempt <span class="op">==</span> max_retries <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Failed to delete </span><span class="sc">{</span>path<span class="sc">}</span><span class="ss"> after </span><span class="sc">{</span>max_retries<span class="sc">}</span><span class="ss"> attempts: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>            time.sleep(delay)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-27" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>force_delete_directory(LANCE_DB_PATH)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We start prefilling our vector database with the metadata</p>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L171" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="initialise_knowledge_base" class="level3">
<h3 class="anchored" data-anchor-id="initialise_knowledge_base">initialise_knowledge_base</h3>
<blockquote class="blockquote">
<pre><code> initialise_knowledge_base (db, evaluation:Dict)</code></pre>
</blockquote>
<p><em>Store full documents without chunking (late chunking approach)</em></p>
<div id="initialise_knowledge_base" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lancedb <span class="im">import</span> <span class="ex">connect</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> safe_get(d, key, default<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Safely get value from dict, handle NaN and missing keys"""</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    value <span class="op">=</span> d.get(key, default)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> value <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> (<span class="bu">isinstance</span>(value, <span class="bu">float</span>) <span class="kw">and</span> np.isnan(value)):</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> default</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> value</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> initialise_knowledge_base(db, evaluation: Dict):</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Store full documents without chunking (late chunking approach)"""</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pyarrow <span class="im">as</span> pa</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> typing <span class="im">import</span> Optional</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># EvaluationModel Schema</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    evaluation_schema <span class="op">=</span> pa.schema([</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"evaluation_id"</span>, pa.string()),</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"title"</span>, pa.string()),</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"year"</span>, pa.string()),</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"author"</span>, pa.string()),</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"donor"</span>, pa.string()),</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"evaluation_commissioner"</span>, pa.string()),</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"migration_thematic_areas"</span>, pa.string()),</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"relevant_crosscutting_themes"</span>, pa.string()),</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"type_of_evaluation_timing"</span>, pa.string()),</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"type_of_evaluator"</span>, pa.string()),</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"level_of_evaluation"</span>, pa.string()),</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"scope"</span>, pa.string()),</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"geography"</span>, pa.list_(pa.string())),</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"summary"</span>, pa.string()),</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"evaluation_type"</span>, pa.string()),</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"population"</span>, pa.string()),</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"intervention"</span>, pa.string()),</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"comparator"</span>, pa.string()),</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"outcome"</span>, pa.string()),</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"methodology"</span>, pa.string()),</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"study_design"</span>, pa.string()),</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"sample_size"</span>, pa.string()),</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"data_collection_techniques"</span>, pa.string()),</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"evidence_strength"</span>, pa.string()),</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"limitations"</span>, pa.string())</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DocumentModel Schema</span></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>    document_schema <span class="op">=</span> pa.schema([</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"document_id"</span>, pa.string()),</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"url"</span>, pa.string()),</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"description"</span>, pa.string()),</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"evaluation_id"</span>, pa.string()),</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"content"</span>, pa.string()),</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"processed"</span>, pa.bool_()),</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"document_title"</span>, pa.string()),</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>        pa.field(<span class="st">"document_type_infer"</span>, pa.string())</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create or open tables with explicit schema</span></span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>        eval_table <span class="op">=</span> db.create_table(<span class="st">"evaluations"</span>, schema<span class="op">=</span>evaluation_schema, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>        doc_table <span class="op">=</span> db.create_table(<span class="st">"documents"</span>, schema<span class="op">=</span>document_schema, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error creating tables: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span></span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>    eval_id <span class="op">=</span> generate_id(<span class="ss">f"</span><span class="sc">{</span>evaluation[<span class="st">'Title'</span>]<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>evaluation[<span class="st">'Year'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare the evaluation record</span></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>    eval_record <span class="op">=</span> {</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">"evaluation_id"</span>: eval_id,</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">"title"</span>: evaluation[<span class="st">"Title"</span>],</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">"year"</span>: evaluation[<span class="st">"Year"</span>],</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">"author"</span>: safe_get(evaluation, <span class="st">"Author"</span>),</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">"donor"</span>: safe_get(evaluation, <span class="st">"Donor"</span>),</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">"evaluation_commissioner"</span>: safe_get(evaluation, <span class="st">"Evaluation Commissioner"</span>),</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">"migration_thematic_areas"</span>: safe_get(evaluation, <span class="st">"Migration Thematic Areas"</span>),</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">"relevant_crosscutting_themes"</span>: safe_get(evaluation, <span class="st">"Relevant Crosscutting Themes"</span>),</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">"type_of_evaluation_timing"</span>: safe_get(evaluation, <span class="st">"Type of Evaluation Timing"</span>),</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">"type_of_evaluator"</span>: safe_get(evaluation, <span class="st">"Type of Evaluator"</span>),</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">"level_of_evaluation"</span>: safe_get(evaluation, <span class="st">"Level of Evaluation"</span>),</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scope"</span>: safe_get(evaluation, <span class="st">"Type of Evaluation Scope"</span>),</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>        <span class="st">"geography"</span>: safe_get(evaluation, <span class="st">"Countries Covered"</span>, []),</span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>        <span class="co">## rest will be filled later by the generate_evaluation_metadata()</span></span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">"summary"</span>: <span class="va">None</span>,</span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">"evaluation_type"</span>: <span class="va">None</span>,</span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">"population"</span>: <span class="va">None</span>,</span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>        <span class="st">"intervention"</span>: <span class="va">None</span>,</span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">"comparator"</span>: <span class="va">None</span>,</span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>        <span class="st">"outcome"</span>: <span class="va">None</span>,</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>        <span class="st">"methodology"</span>: <span class="va">None</span>,</span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>        <span class="st">"study_design"</span>: <span class="va">None</span>,</span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sample_size"</span>: <span class="va">None</span>,</span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a>        <span class="st">"data_collection_techniques"</span>: <span class="va">None</span>,</span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>        <span class="st">"evidence_strength"</span>: <span class="va">None</span>,</span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>        <span class="st">"limitations"</span>: <span class="va">None</span></span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Insert evaluation (convert to RecordBatch first)</span></span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a>    eval_batch <span class="op">=</span> pa.RecordBatch.from_pylist([eval_record], schema<span class="op">=</span>evaluation_schema)  </span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a>    eval_table.add(eval_batch)  </span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(f"Eval Record to insert: {eval_batch}")</span></span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a>    documents <span class="op">=</span> []</span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> doc <span class="kw">in</span> evaluation.get(<span class="st">"Documents"</span>, []):</span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a>        doc_id <span class="op">=</span> generate_id(doc[<span class="st">"File URL"</span>])</span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a>        documents.append({</span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a>            <span class="st">"document_id"</span>: doc_id,</span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a>            <span class="st">"url"</span>: doc[<span class="st">"File URL"</span>],            </span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a>            <span class="st">"description"</span>: doc[<span class="st">"File description"</span>],</span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a>            <span class="st">"evaluation_id"</span>: eval_id,</span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a>            <span class="st">"content"</span>: <span class="st">""</span>,  <span class="co"># Will be filled when processed,</span></span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a>            <span class="st">"processed"</span>: <span class="va">False</span>,            </span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a>            <span class="st">"document_title"</span>: <span class="va">None</span>,</span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a>            <span class="st">"document_type_infer"</span>: <span class="va">None</span> </span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a>   <span class="co"># print(f"Document to insert: {documents}")</span></span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Insert documents with schema validation</span></span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> documents:</span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a>            <span class="co">#if "documents" in db.table_names():</span></span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a>            <span class="co">#    db.drop_table("documents")</span></span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a>            <span class="co"># doc_table = db.create_table("documents", schema=document_schema)</span></span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a>            schema_fields <span class="op">=</span> [f.name <span class="cf">for</span> f <span class="kw">in</span> document_schema]</span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a>            documents_ordered <span class="op">=</span> [{k: doc[k] <span class="cf">for</span> k <span class="kw">in</span> schema_fields} <span class="cf">for</span> doc <span class="kw">in</span> documents]</span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create Arrow table ensuring schema match</span></span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a>            doc_data <span class="op">=</span> pa.Table.from_pylist(documents_ordered)            </span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Align with expected schema</span></span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a>            aligned_data <span class="op">=</span> doc_data.cast(document_schema)            </span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add to LanceDB table</span></span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a>            doc_table.add(aligned_data)</span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb23-136"><a href="#cb23-136" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error adding documents: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-137"><a href="#cb23-137" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Document schema: </span><span class="ch">\n</span><span class="ss">  </span><span class="sc">{</span>doc_data<span class="sc">.</span>schema<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb23-138"><a href="#cb23-138" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Expected schema: </span><span class="sc">{</span>document_schema<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-139"><a href="#cb23-139" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span></span>
<span id="cb23-140"><a href="#cb23-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-141"><a href="#cb23-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> eval_id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L164" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="safe_get" class="level3">
<h3 class="anchored" data-anchor-id="safe_get">safe_get</h3>
<blockquote class="blockquote">
<pre><code> safe_get (d, key, default=None)</code></pre>
</blockquote>
<p><em>Safely get value from dict, handle NaN and missing keys</em></p>
<div id="cell-32" class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>LANCE_DB_PATH <span class="op">=</span> <span class="st">"./lancedb"</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> <span class="ex">connect</span>(LANCE_DB_PATH)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> evaluation <span class="kw">in</span> evaluation_data:  <span class="co"># Assuming evaluation_data is a list</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    initialise_knowledge_base(db, evaluation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s check each evaluation is in the DB -</p>
<div id="cell-34" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>eval_table <span class="op">=</span> db.open_table(<span class="st">"evaluations"</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  Convert to Pandas DataFrame (recommended for display)</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> eval_table.to_pandas()</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and the corresponding documents…</p>
<div id="cell-36" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>LANCE_DB_PATH <span class="op">=</span> <span class="st">"./lancedb"</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lancedb <span class="im">import</span> <span class="ex">connect</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> <span class="ex">connect</span>(LANCE_DB_PATH)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>doc_table <span class="op">=</span> db.open_table(<span class="st">"documents"</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">#  Convert to Pandas DataFrame (recommended for display)</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> doc_table.to_pandas()</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co"># this table includes document_id, url, and evaluation_id</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="download-and-prepare-all-the-files" class="level3">
<h3 class="anchored" data-anchor-id="download-and-prepare-all-the-files">Download and prepare all the files</h3>
<p>Now we build a smart function to download the files from URL: - this function takes an argument the <code>doc_table</code> from the vector DB (<code>doc_table = db.open_table("documents")</code>). this table includes document_id, url, and evaluation_id - then for each document, and in parallelised way, it loads the url and extract the <code>file_name</code> from the <code>url</code> within the table - it builds a local <code>file_path</code> with <code>PDF_Library</code>/<code>evaluation_id</code>/<code>file_name</code> (where <code>PDF_Library</code> is an environment variable) - it checks if the ‘file_name’ is already present and then gracefully exit - if not, it downloads the file_name - this done with with some provision to avoid requesting IP being banned - and ensure some retry until the file is downloaded - if the file_name extension is not pdf, it identify the file extension then it converts it to pdf</p>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L332" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="download_documents" class="level3">
<h3 class="anchored" data-anchor-id="download_documents">download_documents</h3>
<blockquote class="blockquote">
<pre><code> download_documents (doc_table)</code></pre>
</blockquote>
<div id="download_documents" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib.parse <span class="im">import</span> urlparse</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> filetype  <span class="co"># For detecting file type</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>MAX_RETRIES <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>RETRY_DELAY <span class="op">=</span> <span class="dv">5</span>  <span class="co"># base seconds</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>THREADS <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>THROTTLE_DELAY_RANGE <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">3</span>)  <span class="co"># Delay between downloads per thread</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample pool of common User-Agents</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>USER_AGENTS <span class="op">=</span> [</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0 Safari/537.36"</span>,</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.1 Safari/605.1.15"</span>,</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36"</span>,</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mozilla/5.0 (iPhone; CPU iPhone OS 15_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.0 Mobile/15E148 Safari/604.1"</span>,</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:102.0) Gecko/20100101 Firefox/102.0"</span>,</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_documents(doc_table):</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    pdf_root <span class="op">=</span> Path(os.getenv(<span class="st">"PDF_Library"</span>, <span class="st">"./PDF_Library"</span>))</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_doc(doc):</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>        document_id <span class="op">=</span> doc[<span class="st">'document_id'</span>]</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>        url <span class="op">=</span> doc[<span class="st">'url'</span>]</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>        evaluation_id <span class="op">=</span> doc[<span class="st">'evaluation_id'</span>]</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>            file_name <span class="op">=</span> os.path.basename(urlparse(url).path)</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"processing </span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> file_name:</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>                file_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>document_id<span class="sc">}</span><span class="ss">.pdf"</span>  <span class="co"># fallback</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>            file_dir <span class="op">=</span> pdf_root <span class="op">/</span> <span class="bu">str</span>(evaluation_id)</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>            file_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>            file_path <span class="op">=</span> file_dir <span class="op">/</span> file_name</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> file_path.exists():</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="ss">f"[✓] Skipped </span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss"> (already exists)"</span></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Rate throttling (add jitter)</span></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>            time.sleep(random.uniform(<span class="op">*</span>THROTTLE_DELAY_RANGE))</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Retry logic for downloading</span></span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, MAX_RETRIES <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>                    headers <span class="op">=</span> {<span class="st">'User-Agent'</span>: random.choice(USER_AGENTS)}</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>                    response <span class="op">=</span> requests.get(url, headers<span class="op">=</span>headers, timeout<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">with</span> <span class="bu">open</span>(file_path, <span class="st">'wb'</span>) <span class="im">as</span> f:</span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>                            f.write(response.content)</span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f"Status </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> attempt <span class="op">==</span> MAX_RETRIES:</span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="ss">f"[✗] Failed to download </span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss"> after </span><span class="sc">{</span>MAX_RETRIES<span class="sc">}</span><span class="ss"> attempts: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>                    time.sleep(RETRY_DELAY <span class="op">*</span> attempt <span class="op">+</span> random.uniform(<span class="fl">0.5</span>, <span class="fl">2.0</span>))  <span class="co"># exponential backoff + jitter</span></span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Filetype validation</span></span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>            kind <span class="op">=</span> filetype.guess(file_path)</span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>            actual_extension <span class="op">=</span> file_path.suffix.lower().lstrip(<span class="st">'.'</span>)</span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if it's already a PDF by detected type or file extension (case-insensitive)</span></span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>            is_pdf <span class="op">=</span> (kind <span class="kw">and</span> kind.extension.lower() <span class="op">==</span> <span class="st">'pdf'</span>) <span class="kw">or</span> actual_extension <span class="op">==</span> <span class="st">'pdf'</span></span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> is_pdf:</span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a>                pdf_path <span class="op">=</span> file_path.with_suffix(<span class="st">'.pdf'</span>)</span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"The file </span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss"> is not a pdf and shall be converted"</span>)</span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a>                convert_file_to_pdf(file_path, pdf_path)</span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>                file_path.unlink()  <span class="co"># remove original</span></span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="ss">f"[→] Converted </span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss"> to PDF"</span></span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"[✓] Downloaded </span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"[✗] Error processing </span><span class="sc">{</span>url<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fetch documents from table</span></span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a>    documents <span class="op">=</span> doc_table.to_pandas().to_dict(orient<span class="op">=</span><span class="st">"records"</span>)</span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> ThreadPoolExecutor(max_workers<span class="op">=</span>THREADS) <span class="im">as</span> executor:</span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> result <span class="kw">in</span> tqdm(executor.<span class="bu">map</span>(process_doc, documents), total<span class="op">=</span><span class="bu">len</span>(documents)):</span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a>            results.append(result)</span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r <span class="kw">in</span> results:</span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here is the file conversion functions that assumes that <a href="https://www.libreoffice.org/download/download-libreoffice/">libre-office</a> is installed locally.</p>
<pre class="{bash}"><code># Debian/Ubuntu
sudo apt install libreoffice

# Mac (Homebrew)
brew install --cask libreoffice</code></pre>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L447" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="convert_file_to_pdf" class="level3">
<h3 class="anchored" data-anchor-id="convert_file_to_pdf">convert_file_to_pdf</h3>
<blockquote class="blockquote">
<pre><code> convert_file_to_pdf (input_path, output_path)</code></pre>
</blockquote>
<p><em>Converts Word, Excel, or PowerPoint file to PDF using LibreOffice in headless mode. Works on Windows, macOS, and Linux.</em></p>
<div id="convert_file_to_pdf" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_libreoffice_exec():</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Finds the appropriate LibreOffice command based on OS.</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns path to LibreOffice CLI tool or raises an error.</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    system <span class="op">=</span> platform.system()</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows typically installs LibreOffice here</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> system <span class="op">==</span> <span class="st">"Windows"</span>:</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>        possible_paths <span class="op">=</span> [</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r"C:\Program Files\LibreOffice\program\soffice.exe"</span>,</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>            <span class="vs">r"C:\Program Files (x86)\LibreOffice\program\soffice.exe"</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> path <span class="kw">in</span> possible_paths:</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> Path(path).exists():</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> path</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="st">"LibreOffice not found on Windows. Please install it or set it in PATH."</span>)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># On macOS, typically installed via brew or dmg</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> system <span class="op">==</span> <span class="st">"Darwin"</span>:</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>        possible_paths <span class="op">=</span> [</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">"/Applications/LibreOffice.app/Contents/MacOS/soffice"</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> path <span class="kw">in</span> possible_paths:</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> Path(path).exists():</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> path</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fallback to PATH</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> shutil.which(<span class="st">"soffice"</span>) <span class="kw">or</span> shutil.which(<span class="st">"libreoffice"</span>)</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># On Linux, assume it's installed via apt/yum/pacman</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> system <span class="op">==</span> <span class="st">"Linux"</span>:</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> shutil.which(<span class="st">"libreoffice"</span>) <span class="kw">or</span> shutil.which(<span class="st">"soffice"</span>)</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="ss">f"Unsupported operating system: </span><span class="sc">{</span>system<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convert_file_to_pdf(input_path, output_path):</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="co">    Converts Word, Excel, or PowerPoint file to PDF using LibreOffice in headless mode.</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a><span class="co">    Works on Windows, macOS, and Linux.</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>    input_path <span class="op">=</span> Path(input_path)</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>    output_path <span class="op">=</span> Path(output_path)</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> input_path.exists():</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="ss">f"Input file does not exist: </span><span class="sc">{</span>input_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>        libreoffice_exec <span class="op">=</span> find_libreoffice_exec()</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> libreoffice_exec <span class="kw">or</span> <span class="kw">not</span> Path(libreoffice_exec).exists():</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="st">"LibreOffice executable not found."</span>)</span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># LibreOffice generates PDF in the same folder as input, same base name</span></span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>        subprocess.run([</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>            libreoffice_exec,</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--headless"</span>,</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--convert-to"</span>, <span class="st">"pdf"</span>,</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>            <span class="st">"--outdir"</span>, <span class="bu">str</span>(output_path.parent),</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>            <span class="bu">str</span>(input_path)</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>        ], check<span class="op">=</span><span class="va">True</span>, stdout<span class="op">=</span>subprocess.PIPE, stderr<span class="op">=</span>subprocess.PIPE)</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>        generated_pdf <span class="op">=</span> input_path.with_suffix(<span class="st">'.pdf'</span>)</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>        expected_pdf <span class="op">=</span> output_path</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> generated_pdf.exists():</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>            generated_pdf.rename(expected_pdf)</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> expected_pdf.exists():</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span>  <span class="co"># already saved there</span></span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="ss">f"PDF was not generated for: </span><span class="sc">{</span>input_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> subprocess.CalledProcessError <span class="im">as</span> e:</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="ss">f"LibreOffice failed: </span><span class="sc">{</span>e<span class="sc">.</span>stderr<span class="sc">.</span>decode()<span class="sc">.</span>strip()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="ss">f"Conversion error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L411" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="find_libreoffice_exec" class="level3">
<h3 class="anchored" data-anchor-id="find_libreoffice_exec">find_libreoffice_exec</h3>
<blockquote class="blockquote">
<pre><code> find_libreoffice_exec ()</code></pre>
</blockquote>
<p><em>Finds the appropriate LibreOffice command based on OS. Returns path to LibreOffice CLI tool or raises an error.</em></p>
<p>Testing this…</p>
<div id="cell-45" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>doc_table <span class="op">=</span> db.open_table(<span class="st">"documents"</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"PDF_Library"</span>] <span class="op">=</span> <span class="st">"Evaluation_Library"</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>download_documents(doc_table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="now-load-file-content-in-the-vector-db-chunk-and-embedd" class="level3">
<h3 class="anchored" data-anchor-id="now-load-file-content-in-the-vector-db-chunk-and-embedd">Now load file content in the vector DB, chunk and embedd</h3>
<p>Building a function that - this function takes an argument the <code>doc_table</code> from the vector DB (<code>doc_table = db.open_table("documents")</code>). this table includes document_id, url, and evaluation_id, processed - then for each document, and in parallelised way, it loads the url and extract the <code>file_name</code> from the <code>url</code> within the table - it assume a local <code>file_path</code> with <code>PDF_Library</code>/<code>evaluation_id</code>/<code>file_name</code> (where <code>PDF_Library</code> is an environment variable - <code>file_name</code> is extracted from the url - and the <code>file_name</code> extension is sanitised to include systematically ‘.pdf’ ) - It will extract the text from the PDF using PyMuPDF with error handling – it will implement the It will then fill in the chunk table in lancedb, implementing a late chunking approach to avoid duplicate embedding computation, ensure context-aware chunk boundaries and precise span tracking . - the lancedb chunk table schema should be - chunk_id: str - document_id: str - evaluation_id: str - metadata: dict[str, str] - content: str = embedding_fn.SourceField() - vector: Vector(embedding_fn.ndims()) = embedding_fn.VectorField() - Once processed the processed variable in doc_table is set to true</p>
<p>Test the embeddings through lanchain….</p>
<div id="initialise_embeddings" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize embeddings</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_openai <span class="im">import</span> AzureOpenAIEmbeddings</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>embedding_model <span class="op">=</span> AzureOpenAIEmbeddings(</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    deployment<span class="op">=</span>os.getenv(<span class="st">"EMBEDDING_MODEL"</span>),</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.getenv(<span class="st">"AZURE_OPENAI_API_KEY"</span>),</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    azure_endpoint<span class="op">=</span>os.getenv(<span class="st">"AZURE_OPENAI_ENDPOINT"</span>),</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    api_version<span class="op">=</span>os.getenv(<span class="st">"AZURE_OPENAI_API_VERSION_EMBED"</span>),</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    chunk_size<span class="op">=</span><span class="dv">1</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-48" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>test_embedding <span class="op">=</span> embedding_model.embed_query(<span class="st">"Hello world"</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Embedding vector length: </span><span class="sc">{</span><span class="bu">len</span>(test_embedding)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>embedding_dim <span class="op">=</span> <span class="bu">len</span>(test_embedding)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># LanceDB-compatible wrapper</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LangchainEmbeddingWrapper:</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, langchain_embedder):</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._embedder <span class="op">=</span> langchain_embedder</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, texts):</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._embedder.embed_documents(texts)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> ndims(<span class="va">self</span>):</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._dim</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Wrap and use</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>embedding_fn <span class="op">=</span> LangchainEmbeddingWrapper(embedding_model)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="co">#print("Embedding dimension:", embedding_fn.ndims())</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>vec <span class="op">=</span> embedding_fn([<span class="st">"Hello world"</span>])</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Vector through lancedb dim: </span><span class="sc">{</span><span class="bu">len</span>(vec[<span class="dv">0</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(embedding_fn([<span class="st">"Hello world"</span>])[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-49" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">dir</span>(embedding_fn))</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="bu">help</span>(embedding_fn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So first we create the chunk table in lancedb</p>
<div id="cell-51" class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lancedb.pydantic <span class="im">import</span> Vector</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow <span class="im">as</span> pa </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>pa_schema <span class="op">=</span> pa.schema([</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    pa.field(<span class="st">"chunk_id"</span>, pa.string()),</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    pa.field(<span class="st">"document_id"</span>, pa.string()),</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    pa.field(<span class="st">"evaluation_id"</span>, pa.string()),</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    pa.field(<span class="st">"metadata"</span>, pa.string()),  <span class="co"># storing metadata dict as JSON string for simplicity</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    pa.field(<span class="st">"content"</span>, pa.string()),</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    pa.field(<span class="st">"vector"</span>, pa.list_(pa.float32(), embedding_dim)),  <span class="co"># vector as list of floats</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lancedb <span class="im">import</span> <span class="ex">connect</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> <span class="ex">connect</span>(LANCE_DB_PATH)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>chunk_table <span class="op">=</span> db.create_table(<span class="st">"chunks"</span>, schema<span class="op">=</span>pa_schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and then the function creating embeddings chunck for each document</p>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L537" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="process_documents_to_chunks" class="level3">
<h3 class="anchored" data-anchor-id="process_documents_to_chunks">process_documents_to_chunks</h3>
<blockquote class="blockquote">
<pre><code> process_documents_to_chunks (doc_table, chunk_table)</code></pre>
</blockquote>
<div id="process_documents_to_chunks" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fitz  <span class="co"># PyMuPDF</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> uuid</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lancedb.pydantic <span class="im">import</span> Vector</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List, Any</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.text_splitter <span class="im">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Configuration ---</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>CHUNK_SIZE <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>CHUNK_OVERLAP <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>MAX_RETRIES <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>RETRY_BACKOFF <span class="op">=</span> <span class="dv">2</span>  <span class="co"># seconds base (exponential)</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"PDF_Library"</span>] <span class="op">=</span> <span class="st">"Evaluation_Library"</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>LOG_FILE <span class="op">=</span> <span class="st">"chunck_processing.log"</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Setup Logging ---</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>logging.basicConfig(</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    level<span class="op">=</span>logging.INFO,</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">format</span><span class="op">=</span><span class="st">"</span><span class="sc">%(asctime)s</span><span class="st"> [</span><span class="sc">%(levelname)s</span><span class="st">] </span><span class="sc">%(message)s</span><span class="st">"</span>,</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    handlers<span class="op">=</span>[</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>        logging.FileHandler(LOG_FILE),</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>        logging.StreamHandler()</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_documents_to_chunks(doc_table, chunk_table):</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>    PDF_LIBRARY <span class="op">=</span> os.environ[<span class="st">"PDF_Library"</span>]</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Helper: Extract text from PDF ---</span></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> extract_text_from_pdf(pdf_path: Path) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>            doc <span class="op">=</span> fitz.<span class="bu">open</span>(pdf_path)</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>            text <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(page.get_text() <span class="cf">for</span> page <span class="kw">in</span> doc)</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>            doc.close()</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> text.strip()</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>            logging.error(<span class="ss">f"Failed to extract text from </span><span class="sc">{</span>pdf_path<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Helper: Sanitize file name ---</span></span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sanitize_filename_from_url(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>        file_name <span class="op">=</span> Path(url.split(<span class="st">"?"</span>)[<span class="dv">0</span>]).name</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Path(file_name).stem <span class="op">+</span> <span class="st">".pdf"</span></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Helper: Split text into chunks ---</span></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> chunk_text(text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">str</span>]:</span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>        splitter <span class="op">=</span> RecursiveCharacterTextSplitter(</span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>            chunk_size<span class="op">=</span>CHUNK_SIZE,</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>            chunk_overlap<span class="op">=</span>CHUNK_OVERLAP,</span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a>            separators<span class="op">=</span>[<span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, <span class="st">". "</span>, <span class="st">"! "</span>, <span class="st">"? "</span>, <span class="st">" "</span>, <span class="st">""</span>],</span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>            length_function<span class="op">=</span><span class="bu">len</span>,</span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a>            keep_separator<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a>            is_separator_regex<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> splitter.split_text(text)</span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a>    embedding_dim <span class="op">=</span> <span class="st">"5000"</span></span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Helper: Embed with retry ---</span></span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embed_with_retry(text: <span class="bu">str</span>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, MAX_RETRIES <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> embedding_fn([text])[<span class="dv">0</span>]</span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a>                wait_time <span class="op">=</span> RETRY_BACKOFF <span class="op">**</span> attempt</span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a>                logging.warning(<span class="ss">f"Embedding failed (attempt </span><span class="sc">{</span>attempt<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> attempt <span class="op">==</span> MAX_RETRIES:</span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">raise</span></span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a>                time.sleep(wait_time)</span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Threaded processing function ---</span></span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_doc(doc: Dict[<span class="bu">str</span>, Any]) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, Any]:</span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a>        document_id <span class="op">=</span> doc[<span class="st">"document_id"</span>]</span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> doc.get(<span class="st">"processed"</span>, <span class="va">False</span>):</span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a>            logging.info(<span class="ss">f"Already processed: </span><span class="sc">{</span>document_id<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {<span class="st">"document_id"</span>: document_id, <span class="st">"status"</span>: <span class="st">"already_processed"</span>, <span class="st">"chunks"</span>: <span class="dv">0</span>}</span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a>        url <span class="op">=</span> doc[<span class="st">"url"</span>]</span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a>        evaluation_id <span class="op">=</span> doc[<span class="st">"evaluation_id"</span>]</span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a>        file_name <span class="op">=</span> sanitize_filename_from_url(url)</span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a>        file_path <span class="op">=</span> Path(PDF_LIBRARY) <span class="op">/</span> evaluation_id <span class="op">/</span> file_name</span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f"Processing: </span><span class="sc">{</span>document_id<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> file_path.exists():</span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a>            logging.warning(<span class="ss">f"Missing file: </span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {<span class="st">"document_id"</span>: document_id, <span class="st">"status"</span>: <span class="st">"missing_file"</span>, <span class="st">"chunks"</span>: <span class="dv">0</span>}</span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a>        text <span class="op">=</span> extract_text_from_pdf(file_path)</span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> text:</span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a>            logging.warning(<span class="ss">f"No text extracted from: </span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-99"><a href="#cb40-99" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {<span class="st">"document_id"</span>: document_id, <span class="st">"status"</span>: <span class="st">"no_text_extracted"</span>, <span class="st">"chunks"</span>: <span class="dv">0</span>}</span>
<span id="cb40-100"><a href="#cb40-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-101"><a href="#cb40-101" aria-hidden="true" tabindex="-1"></a>        chunks <span class="op">=</span> chunk_text(text)</span>
<span id="cb40-102"><a href="#cb40-102" aria-hidden="true" tabindex="-1"></a>        chunk_records <span class="op">=</span> []</span>
<span id="cb40-103"><a href="#cb40-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-104"><a href="#cb40-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(chunks):</span>
<span id="cb40-105"><a href="#cb40-105" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb40-106"><a href="#cb40-106" aria-hidden="true" tabindex="-1"></a>                chunk_id <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>document_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>uuid<span class="sc">.</span>uuid4()<span class="sc">.</span><span class="bu">hex</span>[:<span class="dv">6</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb40-107"><a href="#cb40-107" aria-hidden="true" tabindex="-1"></a>                vector <span class="op">=</span> embed_with_retry(chunk)</span>
<span id="cb40-108"><a href="#cb40-108" aria-hidden="true" tabindex="-1"></a>                chunk_records.append({</span>
<span id="cb40-109"><a href="#cb40-109" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"chunk_id"</span>: chunk_id,</span>
<span id="cb40-110"><a href="#cb40-110" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"document_id"</span>: document_id,</span>
<span id="cb40-111"><a href="#cb40-111" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"evaluation_id"</span>: evaluation_id,</span>
<span id="cb40-112"><a href="#cb40-112" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"metadata"</span>: json.dumps({<span class="st">"chunk_index"</span>: <span class="bu">str</span>(i)}),</span>
<span id="cb40-113"><a href="#cb40-113" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"content"</span>: chunk,</span>
<span id="cb40-114"><a href="#cb40-114" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"vector"</span>: vector,</span>
<span id="cb40-115"><a href="#cb40-115" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb40-116"><a href="#cb40-116" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb40-117"><a href="#cb40-117" aria-hidden="true" tabindex="-1"></a>                logging.error(<span class="ss">f"Failed to embed chunk </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> of </span><span class="sc">{</span>document_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-118"><a href="#cb40-118" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb40-119"><a href="#cb40-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-120"><a href="#cb40-120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> chunk_records:</span>
<span id="cb40-121"><a href="#cb40-121" aria-hidden="true" tabindex="-1"></a>            chunk_table.add(pd.DataFrame(chunk_records))</span>
<span id="cb40-122"><a href="#cb40-122" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {<span class="st">"document_id"</span>: document_id, <span class="st">"status"</span>: <span class="st">"processed"</span>, <span class="st">"chunks"</span>: <span class="bu">len</span>(chunk_records)}</span>
<span id="cb40-123"><a href="#cb40-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb40-124"><a href="#cb40-124" aria-hidden="true" tabindex="-1"></a>            logging.warning(<span class="ss">f"No chunks processed for </span><span class="sc">{</span>document_id<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-125"><a href="#cb40-125" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {<span class="st">"document_id"</span>: document_id, <span class="st">"status"</span>: <span class="st">"no_chunks_processed"</span>, <span class="st">"chunks"</span>: <span class="dv">0</span>}</span>
<span id="cb40-126"><a href="#cb40-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-127"><a href="#cb40-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load documents</span></span>
<span id="cb40-128"><a href="#cb40-128" aria-hidden="true" tabindex="-1"></a>    documents <span class="op">=</span> doc_table.to_pandas().to_dict(orient<span class="op">=</span><span class="st">"records"</span>)</span>
<span id="cb40-129"><a href="#cb40-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-130"><a href="#cb40-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Threaded processing</span></span>
<span id="cb40-131"><a href="#cb40-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> ThreadPoolExecutor(max_workers<span class="op">=</span><span class="dv">8</span>) <span class="im">as</span> executor:</span>
<span id="cb40-132"><a href="#cb40-132" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> <span class="bu">list</span>(executor.<span class="bu">map</span>(process_doc, documents))</span>
<span id="cb40-133"><a href="#cb40-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-134"><a href="#cb40-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sequential update to avoid LanceDB conflicts</span></span>
<span id="cb40-135"><a href="#cb40-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> result <span class="kw">in</span> results:</span>
<span id="cb40-136"><a href="#cb40-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result[<span class="st">"status"</span>] <span class="op">==</span> <span class="st">"processed"</span>:</span>
<span id="cb40-137"><a href="#cb40-137" aria-hidden="true" tabindex="-1"></a>            document_id <span class="op">=</span> result[<span class="st">"document_id"</span>]</span>
<span id="cb40-138"><a href="#cb40-138" aria-hidden="true" tabindex="-1"></a>            success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb40-139"><a href="#cb40-139" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, MAX_RETRIES <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb40-140"><a href="#cb40-140" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb40-141"><a href="#cb40-141" aria-hidden="true" tabindex="-1"></a>                    doc_table.update(</span>
<span id="cb40-142"><a href="#cb40-142" aria-hidden="true" tabindex="-1"></a>                        where<span class="op">=</span><span class="ss">f"document_id = '</span><span class="sc">{</span>document_id<span class="sc">}</span><span class="ss">'"</span>,</span>
<span id="cb40-143"><a href="#cb40-143" aria-hidden="true" tabindex="-1"></a>                        values<span class="op">=</span>{<span class="st">"processed"</span>: <span class="va">True</span>}</span>
<span id="cb40-144"><a href="#cb40-144" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb40-145"><a href="#cb40-145" aria-hidden="true" tabindex="-1"></a>                    success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb40-146"><a href="#cb40-146" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb40-147"><a href="#cb40-147" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> <span class="pp">RuntimeError</span> <span class="im">as</span> e:</span>
<span id="cb40-148"><a href="#cb40-148" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="st">"Retryable commit conflict"</span> <span class="kw">in</span> <span class="bu">str</span>(e):</span>
<span id="cb40-149"><a href="#cb40-149" aria-hidden="true" tabindex="-1"></a>                        logging.warning(<span class="ss">f"Update conflict for </span><span class="sc">{</span>document_id<span class="sc">}</span><span class="ss">, retrying..."</span>)</span>
<span id="cb40-150"><a href="#cb40-150" aria-hidden="true" tabindex="-1"></a>                        time.sleep(RETRY_BACKOFF <span class="op">**</span> attempt)</span>
<span id="cb40-151"><a href="#cb40-151" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb40-152"><a href="#cb40-152" aria-hidden="true" tabindex="-1"></a>                        logging.error(<span class="ss">f"Failed to update </span><span class="sc">{</span>document_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-153"><a href="#cb40-153" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb40-154"><a href="#cb40-154" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> success:</span>
<span id="cb40-155"><a href="#cb40-155" aria-hidden="true" tabindex="-1"></a>                logging.error(<span class="ss">f"Gave up updating </span><span class="sc">{</span>document_id<span class="sc">}</span><span class="ss"> after retries"</span>)</span>
<span id="cb40-156"><a href="#cb40-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-157"><a href="#cb40-157" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create full-text search index</span></span>
<span id="cb40-158"><a href="#cb40-158" aria-hidden="true" tabindex="-1"></a>    chunk_table.create_fts_index(<span class="st">"content"</span>)</span>
<span id="cb40-159"><a href="#cb40-159" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">"FTS index created on 'content'"</span>)</span>
<span id="cb40-160"><a href="#cb40-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-161"><a href="#cb40-161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final report</span></span>
<span id="cb40-162"><a href="#cb40-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> result <span class="kw">in</span> results:</span>
<span id="cb40-163"><a href="#cb40-163" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'status'</span>]<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>result[<span class="st">'document_id'</span>]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>result[<span class="st">'chunks'</span>]<span class="sc">}</span><span class="ss"> chunks)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now let’s run this!</p>
<div id="cell-56" class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>LANCE_DB_PATH <span class="op">=</span> <span class="st">"./lancedb"</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lancedb <span class="im">import</span> <span class="ex">connect</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> <span class="ex">connect</span>(LANCE_DB_PATH)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>doc_table <span class="op">=</span> db.open_table(<span class="st">"documents"</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>chunk_table <span class="op">=</span> db.open_table(<span class="st">"chunks"</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>process_documents_to_chunks(doc_table, chunk_table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Checking the status of the chunking process</p>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L673" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="check_chunk_status" class="level3">
<h3 class="anchored" data-anchor-id="check_chunk_status">check_chunk_status</h3>
<blockquote class="blockquote">
<pre><code> check_chunk_status (doc_table, chunk_table)</code></pre>
</blockquote>
<div id="check_chunk_status" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_chunk_status(doc_table, chunk_table):</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load documents and chunks as DataFrames</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    docs_df <span class="op">=</span> doc_table.to_pandas()</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    chunks_df <span class="op">=</span> chunk_table.to_pandas()</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count chunks per document_id</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    chunk_counts <span class="op">=</span> chunks_df.groupby(<span class="st">"document_id"</span>).size().reset_index(name<span class="op">=</span><span class="st">"chunk_count"</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge chunk counts into docs_df (left join)</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> docs_df.merge(chunk_counts, on<span class="op">=</span><span class="st">"document_id"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill NaN chunk counts with 0 (documents with no chunks)</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">"chunk_count"</span>] <span class="op">=</span> merged[<span class="st">"chunk_count"</span>].fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define which docs are missing chunks or have zero chunks</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    missing_chunks_df <span class="op">=</span> merged[merged[<span class="st">"chunk_count"</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Summary counts</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    total_docs <span class="op">=</span> <span class="bu">len</span>(docs_df)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    properly_chunked <span class="op">=</span> total_docs <span class="op">-</span> <span class="bu">len</span>(missing_chunks_df)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    missing_count <span class="op">=</span> <span class="bu">len</span>(missing_chunks_df)</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total documents: </span><span class="sc">{</span>total_docs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Properly chunked documents: </span><span class="sc">{</span>properly_chunked<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Documents missing chunks: </span><span class="sc">{</span>missing_count<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> missing_count <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Documents missing chunks:"</span>)</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, row <span class="kw">in</span> missing_chunks_df.iterrows():</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>            doc_id <span class="op">=</span> row[<span class="st">"document_id"</span>]</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>            url <span class="op">=</span> row.get(<span class="st">"url"</span>, <span class="st">"N/A"</span>)</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>            processed <span class="op">=</span> row.get(<span class="st">"processed"</span>, <span class="va">False</span>)</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f" - Document ID: </span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">, URL: </span><span class="sc">{</span>url<span class="sc">}</span><span class="ss">, Processed flag: </span><span class="sc">{</span>processed<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> missing_chunks_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-60" class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>LANCE_DB_PATH <span class="op">=</span> <span class="st">"./lancedb"</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lancedb <span class="im">import</span> <span class="ex">connect</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> <span class="ex">connect</span>(LANCE_DB_PATH)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>doc_table <span class="op">=</span> db.open_table(<span class="st">"documents"</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>chunk_table <span class="op">=</span> db.open_table(<span class="st">"chunks"</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>missing_docs_df <span class="op">=</span> check_chunk_status(doc_table, chunk_table)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(missing_docs_df)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="co"># this table includes document_id, url, and evaluation_id</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="generating-ai-enhanced-metadata" class="level3">
<h3 class="anchored" data-anchor-id="generating-ai-enhanced-metadata">Generating AI-Enhanced metadata</h3>
<p>Last, we run a function to generate metadata…</p>
<p>The function will load the “evaluations” table within the db –connect(LANCE_DB_PATH) – then loop around each evaluation_id within the “chunks” table to retrive the context - and perform an LLM call to then generate as an output additional metadata Then it will update the evaluations table with the output for each evaluation - At the end it will save a json file with a dump of the evaluations table</p>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L830" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_context_for_eval" class="level3">
<h3 class="anchored" data-anchor-id="get_context_for_eval">get_context_for_eval</h3>
<blockquote class="blockquote">
<pre><code> get_context_for_eval (eval_row, query, chunk_table)</code></pre>
</blockquote>
<div id="evaluation_metadata_building" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># setting up for metadata generation</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lancedb <span class="im">import</span> <span class="ex">connect</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tenacity <span class="im">import</span> retry, wait_exponential, stop_after_attempt, retry_if_exception_type</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Load environment variables</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_openai <span class="im">import</span> AzureChatOpenAI </span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>llm_accurate0 <span class="op">=</span> AzureChatOpenAI(</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>    deployment_name<span class="op">=</span>os.getenv(<span class="st">"AZURE_DEPLOYMENT_NAME"</span>),</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.getenv(<span class="st">"AZURE_OPENAI_API_KEY"</span>),</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    azure_endpoint<span class="op">=</span>os.getenv(<span class="st">"AZURE_OPENAI_ENDPOINT"</span>),</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>    api_version<span class="op">=</span>os.getenv(<span class="st">"AZURE_OPENAI_API_VERSION"</span>),</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>    temperature<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span><span class="dv">1000</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="co">## another instance with a better model that can handle longer context...</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>llm_accurate <span class="op">=</span> AzureChatOpenAI(</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>    deployment_name<span class="op">=</span>os.getenv(<span class="st">"model_name"</span>),</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.getenv(<span class="st">"subscription_key"</span>),</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>    azure_endpoint<span class="op">=</span>os.getenv(<span class="st">"endpoint"</span>),</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    api_version<span class="op">=</span>os.getenv(<span class="st">"api_version"</span>),</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    temperature<span class="op">=</span><span class="fl">0.1</span></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up logging</span></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>logging.basicConfig(filename<span class="op">=</span><span class="st">"log/metadata_generation.log"</span>, level<span class="op">=</span>logging.INFO, <span class="bu">format</span><span class="op">=</span><span class="st">"</span><span class="sc">%(asctime)s</span><span class="st"> </span><span class="sc">%(levelname)s</span><span class="st">: </span><span class="sc">%(message)s</span><span class="st">"</span>)</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_json(obj):</span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Recursively clean an object to make it JSON serializable, handling None values."""</span></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> obj <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []  <span class="co"># Convert None to empty list for join operations</span></span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(obj, <span class="bu">dict</span>):</span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {k: clean_json(v) <span class="cf">for</span> k, v <span class="kw">in</span> obj.items()}</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(obj, <span class="bu">list</span>):</span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [clean_json(v) <span class="cf">for</span> v <span class="kw">in</span> obj]</span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(obj, np.ndarray):</span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> obj.tolist()</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">hasattr</span>(obj, <span class="st">"tolist"</span>):  <span class="co"># for other array-like objects</span></span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> obj.tolist()</span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(obj, (np.integer, np.floating)):</span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> obj.item()</span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(obj, (<span class="bu">str</span>, <span class="bu">int</span>, <span class="bu">float</span>, <span class="bu">bool</span>)):</span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> obj</span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(obj, (<span class="bu">list</span>, <span class="bu">tuple</span>)):</span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [clean_json(v) <span class="cf">for</span> v <span class="kw">in</span> obj]    </span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(obj, (np.ndarray, np.generic)):</span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> obj.tolist()    </span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">str</span>(obj)  <span class="co"># fallback for any other type</span></span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Use this safer approach when building context in the prompt</span></span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> safe_join(items, sep<span class="op">=</span><span class="st">', '</span>):</span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> items <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">''</span></span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(items, <span class="st">'tolist'</span>):  <span class="co"># Handle numpy arrays</span></span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a>            items <span class="op">=</span> items.tolist()</span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> sep.join(<span class="bu">str</span>(item) <span class="cf">for</span> item <span class="kw">in</span> items)</span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> (<span class="pp">TypeError</span>, <span class="pp">AttributeError</span>):</span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">''</span> </span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> call_llm_with_retries(prompt, max_retries<span class="op">=</span><span class="dv">4</span>, delay<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(max_retries):</span>
<span id="cb46-77"><a href="#cb46-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb46-78"><a href="#cb46-78" aria-hidden="true" tabindex="-1"></a>            response <span class="op">=</span> llm_accurate.invoke([HumanMessage(content<span class="op">=</span>prompt)])</span>
<span id="cb46-79"><a href="#cb46-79" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the content directly from the AIMessage object</span></span>
<span id="cb46-80"><a href="#cb46-80" aria-hidden="true" tabindex="-1"></a>            raw_output <span class="op">=</span> response.content.strip()</span>
<span id="cb46-81"><a href="#cb46-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-82"><a href="#cb46-82" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Try to parse the JSON</span></span>
<span id="cb46-83"><a href="#cb46-83" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb46-84"><a href="#cb46-84" aria-hidden="true" tabindex="-1"></a>                parsed <span class="op">=</span> json.loads(raw_output)</span>
<span id="cb46-85"><a href="#cb46-85" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Validate the structure isn't just repeating the same value</span></span>
<span id="cb46-86"><a href="#cb46-86" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">isinstance</span>(parsed, <span class="bu">dict</span>) <span class="kw">and</span> <span class="bu">any</span>(<span class="bu">isinstance</span>(v, <span class="bu">list</span>) <span class="kw">and</span> <span class="bu">len</span>(v) <span class="op">&gt;</span> <span class="dv">50</span> <span class="cf">for</span> v <span class="kw">in</span> parsed.values()):</span>
<span id="cb46-87"><a href="#cb46-87" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">raise</span> JSONDecodeError(<span class="st">"Output contains excessively repeated values"</span>, <span class="st">""</span>, <span class="dv">0</span>)</span>
<span id="cb46-88"><a href="#cb46-88" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> parsed</span>
<span id="cb46-89"><a href="#cb46-89" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> JSONDecodeError <span class="im">as</span> e:</span>
<span id="cb46-90"><a href="#cb46-90" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Try to fix common issues</span></span>
<span id="cb46-91"><a href="#cb46-91" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> raw_output.count(<span class="st">'{'</span>) <span class="op">!=</span> raw_output.count(<span class="st">'}'</span>):</span>
<span id="cb46-92"><a href="#cb46-92" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Try to complete the JSON if it was cut off</span></span>
<span id="cb46-93"><a href="#cb46-93" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> raw_output.count(<span class="st">'{'</span>) <span class="op">&gt;</span> raw_output.count(<span class="st">'}'</span>):</span>
<span id="cb46-94"><a href="#cb46-94" aria-hidden="true" tabindex="-1"></a>                        raw_output <span class="op">+=</span> <span class="st">'}'</span></span>
<span id="cb46-95"><a href="#cb46-95" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb46-96"><a href="#cb46-96" aria-hidden="true" tabindex="-1"></a>                        raw_output <span class="op">=</span> <span class="st">'{'</span> <span class="op">+</span> raw_output</span>
<span id="cb46-97"><a href="#cb46-97" aria-hidden="true" tabindex="-1"></a>                parsed <span class="op">=</span> json.loads(raw_output)</span>
<span id="cb46-98"><a href="#cb46-98" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> parsed</span>
<span id="cb46-99"><a href="#cb46-99" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb46-100"><a href="#cb46-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> JSONDecodeError <span class="im">as</span> e:</span>
<span id="cb46-101"><a href="#cb46-101" aria-hidden="true" tabindex="-1"></a>            logging.warning(<span class="ss">f"JSON parsing failed (attempt </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">). Output:</span><span class="ch">\n</span><span class="sc">{</span>raw_output<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-102"><a href="#cb46-102" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> attempt <span class="op">==</span> max_retries <span class="op">-</span> <span class="dv">1</span>:  <span class="co"># Last attempt</span></span>
<span id="cb46-103"><a href="#cb46-103" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Try to salvage partial data</span></span>
<span id="cb46-104"><a href="#cb46-104" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb46-105"><a href="#cb46-105" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Extract the valid part before the cutoff</span></span>
<span id="cb46-106"><a href="#cb46-106" aria-hidden="true" tabindex="-1"></a>                    valid_part <span class="op">=</span> raw_output[:raw_output.rfind(<span class="st">'}'</span>)<span class="op">+</span><span class="dv">1</span>]</span>
<span id="cb46-107"><a href="#cb46-107" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> json.loads(valid_part)</span>
<span id="cb46-108"><a href="#cb46-108" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span>:</span>
<span id="cb46-109"><a href="#cb46-109" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="ss">f"LLM returned malformed JSON that couldn't be repaired: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-110"><a href="#cb46-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb46-111"><a href="#cb46-111" aria-hidden="true" tabindex="-1"></a>            logging.warning(<span class="ss">f"LLM error (attempt </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">): </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-112"><a href="#cb46-112" aria-hidden="true" tabindex="-1"></a>        time.sleep(delay <span class="op">*</span> (<span class="dv">2</span> <span class="op">**</span> attempt))</span>
<span id="cb46-113"><a href="#cb46-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="st">"LLM call failed after retries."</span>)</span>
<span id="cb46-114"><a href="#cb46-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-115"><a href="#cb46-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-116"><a href="#cb46-116" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lancedb.rerankers <span class="im">import</span> RRFReranker</span>
<span id="cb46-117"><a href="#cb46-117" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_context_for_eval(eval_row, query, chunk_table):</span>
<span id="cb46-118"><a href="#cb46-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-119"><a href="#cb46-119" aria-hidden="true" tabindex="-1"></a>    reranker <span class="op">=</span> RRFReranker()</span>
<span id="cb46-120"><a href="#cb46-120" aria-hidden="true" tabindex="-1"></a>    evaluation_id <span class="op">=</span> eval_row[<span class="st">"evaluation_id"</span>]</span>
<span id="cb46-121"><a href="#cb46-121" aria-hidden="true" tabindex="-1"></a>    query_embedding <span class="op">=</span> embedding_fn(query)</span>
<span id="cb46-122"><a href="#cb46-122" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> chunk_table.search(query_embedding).where(</span>
<span id="cb46-123"><a href="#cb46-123" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"evaluation_id = '</span><span class="sc">{</span>evaluation_id<span class="sc">}</span><span class="ss">'"</span>, prefilter<span class="op">=</span><span class="va">True</span></span>
<span id="cb46-124"><a href="#cb46-124" aria-hidden="true" tabindex="-1"></a>    ).limit(<span class="dv">3</span>).to_pandas()</span>
<span id="cb46-125"><a href="#cb46-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-126"><a href="#cb46-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> results.empty:</span>
<span id="cb46-127"><a href="#cb46-127" aria-hidden="true" tabindex="-1"></a>        logging.warning(<span class="ss">f"No chunks found for evaluation_id=</span><span class="sc">{</span>evaluation_id<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-128"><a href="#cb46-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb46-129"><a href="#cb46-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-130"><a href="#cb46-130" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([</span>
<span id="cb46-131"><a href="#cb46-131" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Document:</span><span class="ch">\n</span><span class="sc">{</span>row[<span class="st">'content'</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb46-132"><a href="#cb46-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, row <span class="kw">in</span> results.iterrows()</span>
<span id="cb46-133"><a href="#cb46-133" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb46-134"><a href="#cb46-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> context</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L788" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="call_llm_with_retries" class="level3">
<h3 class="anchored" data-anchor-id="call_llm_with_retries">call_llm_with_retries</h3>
<blockquote class="blockquote">
<pre><code> call_llm_with_retries (prompt, max_retries=4, delay=2)</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L776" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="safe_join" class="level3">
<h3 class="anchored" data-anchor-id="safe_join">safe_join</h3>
<blockquote class="blockquote">
<pre><code> safe_join (items, sep=', ')</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L751" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="clean_json" class="level3">
<h3 class="anchored" data-anchor-id="clean_json">clean_json</h3>
<blockquote class="blockquote">
<pre><code> clean_json (obj)</code></pre>
</blockquote>
<p><em>Recursively clean an object to make it JSON serializable, handling None values.</em></p>
<p>We will use the <strong>PICO structured framework</strong> as an approach to represent the causal knowledge found in the Evaluation (cf.&nbsp;<a href="https://aclanthology.org/2023.findings-emnlp.774.pdf">EconBERTa: Towards Robust Extraction of Named Entities in Economics</a>). This scheme helps in systematically organizing and analyzing the effectiveness of interventions by comparing outcomes between groups:</p>
<p><strong>1. Population (P)</strong>: The group of individuals or units (e.g., households, schools, firms) affected by the intervention. The target population shall be clearly defined (e.g., smallholder farmers, primary school students, unemployed youth) and it shall Include eligibility criteria (e.g., age, socioeconomic status, geographic location).</p>
<p><strong>2. Intervention (I)</strong>: The program, policy, or treatment whose effect is being evaluated. Describes the active component being tested (e.g., cash transfers, training workshops, new teaching methods). Should specify dosage, duration, and delivery mechanism.</p>
<p><strong>3. Comparators (C)</strong>: The counterfactual scenario—what would have happened without the intervention. Ideally involves a control group (if the study approach is randomized or quasi-experimental) that does not receive the intervention. Alternatively refers to “Business-as-usual” groups, placebo interventions, or different treatment arms.</p>
<p><strong>4. Outcome (O)</strong>:The measurable effects or endpoints used to assess the intervention’s impact. Includes primary outcomes (main indicators of interest, e.g., school enrollment rates, income levels) and secondary outcomes (e.g., health, empowerment). Should be specific, measurable, and time-bound (e.g., “child literacy scores after 12 months”).</p>
<p>Using such approach, we can ensure Clarity (the research question is well-defined and testable), Causal Inference (isolate the effect of the intervention by comparing treated and untreated groups), Replicability (to potentially extrapolate the findings) and Relevance (linking outcomes to real-world decision-making).</p>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L858" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="generate_metadata_for_evaluation_metadata_descriptive" class="level3">
<h3 class="anchored" data-anchor-id="generate_metadata_for_evaluation_metadata_descriptive">generate_metadata_for_evaluation_metadata_descriptive</h3>
<blockquote class="blockquote">
<pre><code> generate_metadata_for_evaluation_metadata_descriptive (eval_row,
                                                        query_descriptive,
                                                        chunk_table)</code></pre>
</blockquote>
<p><em>Process one evaluation row and return updated row with metadata.</em></p>
<div id="generate_metadata_for_evaluation_metadata_descriptive" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># descriptive</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.schema <span class="im">import</span> HumanMessage</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> json <span class="im">import</span> JSONDecodeError</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define query and embedding</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>query_descriptive <span class="op">=</span> <span class="st">" Population, Intervention, Outcome, comparator"</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_metadata_for_evaluation_metadata_descriptive(eval_row, query_descriptive, chunk_table):</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Process one evaluation row and return updated row with metadata."""</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    evaluation_id <span class="op">=</span> eval_row[<span class="st">"evaluation_id"</span>]</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> get_context_for_eval(eval_row, query_descriptive, chunk_table)</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="ss">    You are an expert in public program and policy evaluation implementation. </span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="ss">    Your task is to generate evaluation metadata related to a specific evaluation excercise:</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Summary:  Provide a summary of the 5 key main generic recommandations from the evaluation</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Population:  The group of individuals or units (e.g., households, schools, firms) affected by the intervention. </span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Intervention: The program, policy, or treatment whose effect is being evaluated. Describes the active component being tested (e.g., cash transfers, training workshops, new teaching methods). Should specify dosage, duration, and delivery mechanism.</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Comparators: The counterfactual scenario, i.e. what would have happened without the intervention. Ideally involves a control group (if the study approach is randomized or quasi-experimental) that does not receive the intervention. Alternatively refers to "Business-as-usual" groups, placebo interventions, or different treatment arms.</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Outcome:The measurable effects or endpoints used to assess the intervention’s impact. Includes primary outcomes (main indicators of interest, e.g., school enrollment rates, income levels) and secondary outcomes (e.g., health, empowerment). Should be specific, measurable, and time-bound (e.g., "child literacy scores after 12 months").</span></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a><span class="ss">    Below are some existing Metadata on this evaluation:</span></span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Title: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'title'</span>)<span class="sc">}</span></span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Year: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'year'</span>)<span class="sc">}</span></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Author: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'author'</span>)<span class="sc">}</span></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Evaluation Coverage: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'level_of_evaluation'</span>)<span class="sc">}</span></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Type of Evaluation Scope: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'scope'</span>)<span class="sc">}</span></span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Type of Evaluation Timing: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'type_of_evaluation_timing'</span>)<span class="sc">}</span></span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Thematic Areas: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'migration_thematic_areas'</span>)<span class="sc">}</span></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Cross cutting themes: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'relevant_crosscutting_themes'</span>)<span class="sc">}</span></span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Countries: </span><span class="sc">{</span>safe_join(eval_row.get(<span class="st">'geography'</span>))<span class="sc">}</span></span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a><span class="ss">    and some Relevant Document Context:</span></span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span><span class="sc">{</span>context<span class="sc">}</span></span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a><span class="ss">    Return ONLY valid JSON with the following structure:</span></span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span><span class="ch">{{</span></span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a><span class="ss">        "summary":  "" ,</span></span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a><span class="ss">        "population": ["population1", "population2", ...],</span></span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a><span class="ss">        "intervention": ["intervention1", "intervention2", ...],</span></span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a><span class="ss">        "comparator": ["comparator1", "comparator2", ...],</span></span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a><span class="ss">        "outcome": ["outcome1", "outcome2", ...]</span></span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span><span class="ch">}}</span></span>
<span id="cb51-52"><a href="#cb51-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a><span class="ss">    Important Rules:</span></span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a><span class="ss">    1. Each array should contain no more than 10 items</span></span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a><span class="ss">    2. Items should be distinct and non-repetitive</span></span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a><span class="ss">    3. Return ONLY the JSON object, no additional text</span></span>
<span id="cb51-57"><a href="#cb51-57" aria-hidden="true" tabindex="-1"></a><span class="ss">    4. Anchor the response into the provided context and exisiting metadata</span></span>
<span id="cb51-58"><a href="#cb51-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-59"><a href="#cb51-59" aria-hidden="true" tabindex="-1"></a><span class="ss">    """</span></span>
<span id="cb51-60"><a href="#cb51-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-61"><a href="#cb51-61" aria-hidden="true" tabindex="-1"></a>   <span class="co"># logging.info(f"Sending prompt to LLM for evaluation_id={evaluation_id}:\n{prompt}")</span></span>
<span id="cb51-62"><a href="#cb51-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-63"><a href="#cb51-63" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="ss">f"Sending prompt to LLM for Description evaluation_id=</span><span class="sc">{</span>evaluation_id<span class="sc">}</span><span class="ss"> "</span>)</span>
<span id="cb51-64"><a href="#cb51-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb51-65"><a href="#cb51-65" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> call_llm_with_retries(prompt)</span>
<span id="cb51-66"><a href="#cb51-66" aria-hidden="true" tabindex="-1"></a>        eval_row.update(metadata)</span>
<span id="cb51-67"><a href="#cb51-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">#logging.info(f"Processed evaluation_id={evaluation_id}")</span></span>
<span id="cb51-68"><a href="#cb51-68" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f"Description </span><span class="sc">{</span>eval_row<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-69"><a href="#cb51-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> eval_row</span>
<span id="cb51-70"><a href="#cb51-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb51-71"><a href="#cb51-71" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"LLM failed for Description of evaluation_id=</span><span class="sc">{</span>evaluation_id<span class="sc">}</span><span class="ss"> | </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-72"><a href="#cb51-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L934" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="generate_metadata_for_evaluation_metadata_methodo" class="level3">
<h3 class="anchored" data-anchor-id="generate_metadata_for_evaluation_metadata_methodo">generate_metadata_for_evaluation_metadata_methodo</h3>
<blockquote class="blockquote">
<pre><code> generate_metadata_for_evaluation_metadata_methodo (eval_row,
                                                    query_methodo,
                                                    chunk_table)</code></pre>
</blockquote>
<p><em>Process one evaluation row and return updated row with metadata.</em></p>
<div id="generate_metadata_for_evaluation_metadata_methodo" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">#methodo</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.schema <span class="im">import</span> HumanMessage</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define query and embedding</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>query_methodo <span class="op">=</span> <span class="st">"Study design, Methodology, Sample, Data Collection"</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_metadata_for_evaluation_metadata_methodo(eval_row, query_methodo, chunk_table):</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Process one evaluation row and return updated row with metadata."""</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    evaluation_id <span class="op">=</span> eval_row[<span class="st">"evaluation_id"</span>]</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> get_context_for_eval(eval_row, query_methodo, chunk_table)</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="ss">    You are an expert in public program and policy evaluation implementation. </span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="ss">    Your task is to generate the following evaluation metadata about the methodology from a specific evaluation excercise: </span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a><span class="ss">    - evaluation type</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="ss">    - study_design</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="ss">    - methodology (qualitative, quantitative, mixed methods)</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="ss">    - sample_size: description of the sample used for the study</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="ss">    - data_collection_techniques (e.g. surveys, interviews, focus groups, document review).</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="ss"> </span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a><span class="ss">    Use the following list of evaluation type:</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Formative Evaluation: Conducted during development/implementation to improve the programme, </span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Process Evaluation: Examine implementation fidelity and operations, </span></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Outcome Evaluation: Measures short-term/intermediate results (between output and impact), </span></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Summative Evaluation: Assess overall effectiveness after completion, </span></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Impact Evaluation: Measure long-term effects and causal attribution, </span></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a><span class="ss">    Use the following list of study design types</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a><span class="ss">    - "Observational - Cross-sectional: Data collected at a single point in time, no follow-up.",</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a><span class="ss">    - "Observational - Cohort: Participants followed over time without experimental manipulation.",</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a><span class="ss">    - "Experimental - Randomized Controlled Trial: Participants or units are randomly assigned to groups.",</span></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a><span class="ss">    - "Experimental - Quasi-experimental: Includes comparison or time series design without randomization.",</span></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a><span class="ss">    - "Hybrid Type 1: Primarily tests intervention effectiveness while collecting limited implementation data.",</span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a><span class="ss">    - "Hybrid Type 2: Simultaneously tests intervention  and implementation strategies.",</span></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a><span class="ss">    - "Hybrid Type 3: Primarily tests implementation strategies while collecting limited intervention effectiveness data.",</span></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a><span class="ss">    - "Case Study / Mixed-methods: In-depth exploration of implementation in one or few settings using qualitative and/or quantitative data." </span></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a><span class="ss">    Below are some existing Metadata on this specific evaluation:</span></span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Title: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'title'</span>)<span class="sc">}</span></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Year: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'year'</span>)<span class="sc">}</span></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Author: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'author'</span>)<span class="sc">}</span></span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Evaluation Coverage: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'level_of_evaluation'</span>)<span class="sc">}</span></span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Type of Evaluation Scope: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'scope'</span>)<span class="sc">}</span></span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Type of Evaluation Timing: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'type_of_evaluation_timing'</span>)<span class="sc">}</span></span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Thematic Areas: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'migration_thematic_areas'</span>)<span class="sc">}</span></span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Cross cutting themes: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'relevant_crosscutting_themes'</span>)<span class="sc">}</span></span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Countries: </span><span class="sc">{</span>safe_join(eval_row.get(<span class="st">'geography'</span>))<span class="sc">}</span></span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Summary: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'summary'</span>)<span class="sc">}</span></span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Populations: </span><span class="sc">{</span>safe_join(eval_row.get(<span class="st">'population'</span>))<span class="sc">}</span></span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Interventions: </span><span class="sc">{</span>safe_join(eval_row.get(<span class="st">'intervention'</span> ))<span class="sc">}</span></span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Compators: </span><span class="sc">{</span>safe_join(eval_row.get(<span class="st">'comparator'</span>))<span class="sc">}</span></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Outcomes: </span><span class="sc">{</span>safe_join(eval_row.get(<span class="st">'outcome'</span>))<span class="sc">}</span></span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a><span class="ss">    and some Relevant Document Context  on this specific evaluation:</span></span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span><span class="sc">{</span>context<span class="sc">}</span></span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a><span class="ss">    Return ONLY valid JSON with the following structure:</span></span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span><span class="ch">{{</span></span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a><span class="ss">        "methodology":  "" ,</span></span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a><span class="ss">        "evaluation_type":  ["evaluation_type1", "evaluation_type2", ...] ,</span></span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a><span class="ss">        "study_design":  "",</span></span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a><span class="ss">        "sample_size":  "" , </span></span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a><span class="ss">        "data_collection_techniques": ["data_collection_techniques1", "data_collection_techniques2", ...] </span></span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span><span class="ch">}}</span></span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a><span class="ss">    Important Rules:</span></span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a><span class="ss">    1. Each array should contain no more than 10 items</span></span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a><span class="ss">    2. Items should be distinct and non-repetitive</span></span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a><span class="ss">    3. Return ONLY the JSON object, no additional text</span></span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a><span class="ss">    4. Anchor the response into the provided context and exisiting metadata</span></span>
<span id="cb53-76"><a href="#cb53-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-77"><a href="#cb53-77" aria-hidden="true" tabindex="-1"></a><span class="ss">    """</span></span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a>   <span class="co"># logging.info(f"Sending prompt to LLM for evaluation_id={evaluation_id}:\n{prompt}")</span></span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="ss">f"Sending prompt to LLM for methodology  evaluation_id=</span><span class="sc">{</span>evaluation_id<span class="sc">}</span><span class="ss"> "</span>)</span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb53-83"><a href="#cb53-83" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> call_llm_with_retries(prompt)</span>
<span id="cb53-84"><a href="#cb53-84" aria-hidden="true" tabindex="-1"></a>        eval_row.update(metadata)</span>
<span id="cb53-85"><a href="#cb53-85" aria-hidden="true" tabindex="-1"></a>        <span class="co">#logging.info(f"Processed methodology  evaluation_id={evaluation_id}")</span></span>
<span id="cb53-86"><a href="#cb53-86" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f" </span><span class="sc">{</span>eval_row<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-87"><a href="#cb53-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> eval_row</span>
<span id="cb53-88"><a href="#cb53-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb53-89"><a href="#cb53-89" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"LLM failed for methodology of evaluation_id=</span><span class="sc">{</span>evaluation_id<span class="sc">}</span><span class="ss"> | </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-90"><a href="#cb53-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L1029" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="generate_metadata_for_evaluation_metadata_evidence" class="level3">
<h3 class="anchored" data-anchor-id="generate_metadata_for_evaluation_metadata_evidence">generate_metadata_for_evaluation_metadata_evidence</h3>
<blockquote class="blockquote">
<pre><code> generate_metadata_for_evaluation_metadata_evidence (eval_row, query,
                                                     chunk_table)</code></pre>
</blockquote>
<p><em>Process one evaluation row and return updated row with metadata.</em></p>
<div id="generate_metadata_for_evaluation_metadata_evidence" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># evidence</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.schema <span class="im">import</span> HumanMessage</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define query and embedding</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"Evidence Limitation findings recommendations"</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_metadata_for_evaluation_metadata_evidence(eval_row, query, chunk_table):</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Process one evaluation row and return updated row with metadata."""</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    evaluation_id <span class="op">=</span> eval_row[<span class="st">"evaluation_id"</span>]</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> get_context_for_eval(eval_row, query, chunk_table)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a><span class="ss">    You are an expert in public program and policy evaluation implementation. </span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a><span class="ss">    Your task is to generate evaluation metadata about the evaluation output:</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a><span class="ss">     - evidence_strength </span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a><span class="ss">     - limitations </span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a><span class="ss"> </span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a><span class="ss">    Below are some existing Metadata on this evaluation:</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Title: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'title'</span>)<span class="sc">}</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Year: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'year'</span>)<span class="sc">}</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Author: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'author'</span>)<span class="sc">}</span></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Evaluation Coverage: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'level_of_evaluation'</span>)<span class="sc">}</span></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Type of Evaluation Scope: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'scope'</span>)<span class="sc">}</span></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Type of Evaluation Timing: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'type_of_evaluation_timing'</span>)<span class="sc">}</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Thematic Areas: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'migration_thematic_areas'</span>)<span class="sc">}</span></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Cross cutting themes: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'relevant_crosscutting_themes'</span>)<span class="sc">}</span></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Countries: </span><span class="sc">{</span>safe_join(eval_row.get(<span class="st">'geography'</span>, []))<span class="sc">}</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Summary: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'summary'</span>)<span class="sc">}</span></span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Populations: </span><span class="sc">{</span>safe_join(eval_row.get(<span class="st">'population'</span>))<span class="sc">}</span></span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Interventions: </span><span class="sc">{</span>safe_join(eval_row.get(<span class="st">'intervention'</span>))<span class="sc">}</span></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Compators: </span><span class="sc">{</span>safe_join(eval_row.get(<span class="st">'comparator'</span>))<span class="sc">}</span></span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Outcomes: </span><span class="sc">{</span>safe_join(eval_row.get(<span class="st">'outcome'</span>))<span class="sc">}</span></span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Study Design: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'study_design'</span>)<span class="sc">}</span></span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Evaluation type:  </span><span class="sc">{</span>safe_join(eval_row.get(<span class="st">'evaluation_type'</span>))<span class="sc">}</span></span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Methodology: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'methodology'</span>)<span class="sc">}</span></span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Sample size: </span><span class="sc">{</span>eval_row<span class="sc">.</span>get(<span class="st">'sample_size'</span>)<span class="sc">}</span></span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a><span class="ss">    - Data collection techniques:  </span><span class="sc">{</span>safe_join(eval_row.get(<span class="st">'data_collection_techniques'</span>))<span class="sc">}</span></span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a><span class="ss"> </span></span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a><span class="ss">    and some Relevant Document Context:</span></span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span><span class="sc">{</span>context<span class="sc">}</span></span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true" tabindex="-1"></a><span class="ss">    Return ONLY valid JSON with the following structure:</span></span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span><span class="ch">{{</span></span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true" tabindex="-1"></a><span class="ss">        "evidence_strength":  "" ,</span></span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true" tabindex="-1"></a><span class="ss">        "limitations":  ["limitations1", "limitations2", ...]  </span></span>
<span id="cb55-51"><a href="#cb55-51" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span><span class="ch">}}</span></span>
<span id="cb55-52"><a href="#cb55-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-53"><a href="#cb55-53" aria-hidden="true" tabindex="-1"></a><span class="ss">    Important Rules:</span></span>
<span id="cb55-54"><a href="#cb55-54" aria-hidden="true" tabindex="-1"></a><span class="ss">    1. Each array should contain no more than 10 items</span></span>
<span id="cb55-55"><a href="#cb55-55" aria-hidden="true" tabindex="-1"></a><span class="ss">    2. Items should be distinct and non-repetitive</span></span>
<span id="cb55-56"><a href="#cb55-56" aria-hidden="true" tabindex="-1"></a><span class="ss">    3. Return ONLY the JSON object, no additional text</span></span>
<span id="cb55-57"><a href="#cb55-57" aria-hidden="true" tabindex="-1"></a><span class="ss">    4. Anchor the response into the provided context and exisiting metadata</span></span>
<span id="cb55-58"><a href="#cb55-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-59"><a href="#cb55-59" aria-hidden="true" tabindex="-1"></a><span class="ss">    """</span></span>
<span id="cb55-60"><a href="#cb55-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-61"><a href="#cb55-61" aria-hidden="true" tabindex="-1"></a>   <span class="co"># logging.info(f"Sending prompt to LLM for evaluation_id={evaluation_id}:\n{prompt}")</span></span>
<span id="cb55-62"><a href="#cb55-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-63"><a href="#cb55-63" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="ss">f"Sending prompt to LLM for Evidence evaluation_id=</span><span class="sc">{</span>evaluation_id<span class="sc">}</span><span class="ss"> "</span>)</span>
<span id="cb55-64"><a href="#cb55-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb55-65"><a href="#cb55-65" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> call_llm_with_retries(prompt)</span>
<span id="cb55-66"><a href="#cb55-66" aria-hidden="true" tabindex="-1"></a>        eval_row.update(metadata)</span>
<span id="cb55-67"><a href="#cb55-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">#logging.info(f"Processed Evidence evaluation_id={evaluation_id}")</span></span>
<span id="cb55-68"><a href="#cb55-68" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f" </span><span class="sc">{</span>eval_row<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb55-69"><a href="#cb55-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> eval_row</span>
<span id="cb55-70"><a href="#cb55-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb55-71"><a href="#cb55-71" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"LLM failed for Evidence evaluation_id=</span><span class="sc">{</span>evaluation_id<span class="sc">}</span><span class="ss"> | </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb55-72"><a href="#cb55-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/iom/evaluation_knowledge/blob/main/evaluation_knowledge/core.py#L1101" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="generate_evaluation_metadata" class="level3">
<h3 class="anchored" data-anchor-id="generate_evaluation_metadata">generate_evaluation_metadata</h3>
<blockquote class="blockquote">
<pre><code> generate_evaluation_metadata (eval_table, chunk_table, batch_size=10,
                               output_file='all_evaluations_metadata.json'
                               )</code></pre>
</blockquote>
<p><em>Main function to generate metadata in batches and update the table, with incremental saving.</em></p>
<div id="generate_evaluation_metadata" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># process all</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_evaluation_metadata(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    eval_table,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    chunk_table, </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">10</span>, </span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    output_file<span class="op">=</span><span class="st">"all_evaluations_metadata.json"</span>):</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main function to generate metadata in batches and update the table, with incremental saving."""</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    all_rows <span class="op">=</span> eval_table.to_pandas().to_dict(orient<span class="op">=</span><span class="st">"records"</span>)</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    enriched_data <span class="op">=</span> []</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> <span class="bu">len</span>(all_rows)</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="ss">f"processing </span><span class="sc">{</span>total<span class="sc">}</span><span class="ss"> evaluations!"</span>)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    skipped <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize or load existing data if file exists</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(output_file, <span class="st">"r"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>            enriched_data <span class="op">=</span> json.load(f)</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>            logging.info(<span class="ss">f"Loaded existing data with </span><span class="sc">{</span><span class="bu">len</span>(enriched_data)<span class="sc">}</span><span class="ss"> entries"</span>)</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> (<span class="pp">FileNotFoundError</span>, json.JSONDecodeError):</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(all_rows), batch_size):</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>        batch <span class="op">=</span> all_rows[i:i<span class="op">+</span>batch_size]</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>        enriched_batch <span class="op">=</span> []</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> row <span class="kw">in</span> batch:</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>            enriched <span class="op">=</span> generate_metadata_for_evaluation_metadata_descriptive(row, query, chunk_table)</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> enriched:</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>                row <span class="op">=</span> enriched  <span class="co"># update row with enriched version</span></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>                success <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>                skipped <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>            enriched <span class="op">=</span> generate_metadata_for_evaluation_metadata_methodo(row, query, chunk_table)</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> enriched:</span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>                row <span class="op">=</span> enriched</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>                success <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>                skipped <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>            enriched <span class="op">=</span> generate_metadata_for_evaluation_metadata_evidence(row, query, chunk_table)</span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> enriched:</span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>                row <span class="op">=</span> enriched</span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>                success <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a>                skipped <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a>            enriched_batch.append(clean_json(row))</span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> enriched_batch:</span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a>            enriched_data.extend(enriched_batch)</span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Incrementally save after each batch</span></span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> <span class="bu">open</span>(output_file, <span class="st">"w"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a>                json.dump(enriched_data, f, ensure_ascii<span class="op">=</span><span class="va">False</span>, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true" tabindex="-1"></a>            logging.info(<span class="ss">f"Processed batch </span><span class="sc">{</span>i<span class="op">//</span>batch_size <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">, added </span><span class="sc">{</span><span class="bu">len</span>(enriched_batch)<span class="sc">}</span><span class="ss"> rows. Total so far: </span><span class="sc">{</span><span class="bu">len</span>(enriched_data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-61"><a href="#cb57-61" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">2</span>)  <span class="co"># prevent overloading LLM/API</span></span>
<span id="cb57-62"><a href="#cb57-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-63"><a href="#cb57-63" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"[✓] Metadata generation complete. Success: </span><span class="sc">{</span>success<span class="sc">}</span><span class="ss">, Skipped: </span><span class="sc">{</span>skipped<span class="sc">}</span><span class="ss">, Total: </span><span class="sc">{</span>total<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb57-64"><a href="#cb57-64" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="ss">f"Final counts — Success: </span><span class="sc">{</span>success<span class="sc">}</span><span class="ss">, Skipped: </span><span class="sc">{</span>skipped<span class="sc">}</span><span class="ss">, Total: </span><span class="sc">{</span>total<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb57-65"><a href="#cb57-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-66"><a href="#cb57-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> enriched_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now let’s run it!</p>
<div id="cell-77" class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize DB</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>LANCE_DB_PATH <span class="op">=</span> <span class="st">"./lancedb"</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> <span class="ex">connect</span>(LANCE_DB_PATH)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>eval_table <span class="op">=</span> db.open_table(<span class="st">"evaluations"</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>chunk_table <span class="op">=</span> db.open_table(<span class="st">"chunks"</span>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>enriched_data<span class="op">=</span> generate_evaluation_metadata(eval_table, chunk_table, output_file<span class="op">=</span><span class="st">"all_evaluations_metadata2.json"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="step-2-structured-information-extraction" class="level2">
<h2 class="anchored" data-anchor-id="step-2-structured-information-extraction">Step 2: Structured Information Extraction</h2>
<section id="standard-questions" class="level3">
<h3 class="anchored" data-anchor-id="standard-questions">Standard Questions</h3>
<pre class="{python}"><code># Define the list of experts on impact - outcome - organisation
q_experts = [
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the Strategic Impact: ---Attaining favorable protection environments---: i.e., finding or recommendations that require a change in existing policy and regulations. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the Strategic Impact: ---Realizing rights in safe environments---: i.e., finding or recommendations that require a change in existing policy and regulations. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the Strategic Impact: ---Empowering communities and achieving gender equality--- : i.e., finding or recommendations that require a change in existing policy and regulations. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the Strategic Impact: ---Securing durable solutions--- : i.e., finding or recommendations that require a change in existing policy and regulations. [/INST]",

   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: ---Access to territory registration and documentation ---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: --- Status determination ---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: --- Protection policy and law---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: --- Gender-based violence ---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: --- Child protection ---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: --- Safety and access to justice ---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: --- Community engagement and women's empowerment ---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: --- Well-being and basic needs ---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: --- Sustainable housing and settlements ---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: --- Healthy lives---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: --- Education ---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: --- Clean water sanitation and hygiene ---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: --- Self-reliance, Economic inclusion, and livelihoods ---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: --- Voluntary repatriation and sustainable reintegration ---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: --- Resettlement and complementary pathways---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on the specific Operational Outcome: --- Local integration and other local solutions ---, i.e. finding or recommendations that require a change that needs to be implemented in the field as an adaptation or change of current activities. [/INST]", 


   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on Organizational Enablers related to Systems and processes, i.e. elements that require potential changes in either management practices, technical approach, business processes, staffing allocation or capacity building. [/INST]",
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on Organizational Enablers related to Operational support and supply chain, i.e. elements that require potential changes in either management practices, technical approach, business processes, staffing allocation or capacity building. [/INST]" ,
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on Organizational Enablers related to People and culture, i.e. elements that require potential changes in either management practices, technical approach, business processes, staffing allocation or capacity building. [/INST]" ,
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on Organizational Enablers related to External engagement and resource mobilization, i.e. elements that require potential changes in either management practices, technical approach, business processes, staffing allocation or capacity building. [/INST]" ,
   "&lt;s&gt; [INST] Instructions: Act as a public program evaluation expert working for UNHCR. Your specific area of expertise and focus is strictly on Organizational Enablers related to Leadership and governance, i.e. elements that require potential changes in either management practices, technical approach, business processes, staffing allocation or capacity building. [/INST]" 
]

# Predefined knowledge extraction questions
q_questions = [
    " List, as bullet points, all findings and evidences in relation to your specific area of expertise and focus. ",
    " Explain, in relation to your specific area of expertise and focus, what are the root causes for the situation. " ,
    " Explain, in relation to your specific area of expertise and focus, what are the main risks and difficulties here described. ",
    " Explain, in relation to your specific area of expertise and focus, what what can be learnt. ",
    " List, as bullet points, all recommendations made in relation to your specific area of expertise and focus. "#,
    # "Indicate if mentionnend what resource will be required to implement the recommendations made in relation to your specific area of expertise and focus. ",
    # "List, as bullet points, all recommendations made in relation to your specific area of expertise and focus that relates to topics  or activities recommended to be discontinued. ",
    # "List, as bullet points, all recommendations made in relation to your specific area of expertise and focus that relates to topics or activities recommended to be scaled up. " 
    # Add more questions here...
]

## Additional instructions!
q_instr = """
&lt;/s&gt;
[INST]  
Keep your answer grounded in the facts of the contexts. 
If the contexts do not contain the facts to answer the QUESTION, return {NONE} 
Be concise in the response and  when relevant include precise citations from the contexts. 
[/INST] 
"""</code></pre>
</section>
<section id="qa-extraction" class="level3">
<h3 class="anchored" data-anchor-id="qa-extraction">Q&amp;A Extraction</h3>
<pre class="{python}"><code>qa_questions = [
    "What was the intervention type?",
    "What outcomes were observed?",
    "What population was targeted?",
    "What geographic area was covered?",
    "How strong is the evidence?",
]

def generate_qas(text):
    prompt = f"""Extract answers to the following questions from the evaluation:
    {json.dumps(qa_questions)}
    
    Text: {text[:3000]}
    """
    completion = client.chat.completions.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.2
    )
    return completion.choices[0].message.content

df_docs["qa"] = df_docs["text"].apply(generate_qas)</code></pre>
</section>
<section id="hybrid-search-in-lancedb" class="level3">
<h3 class="anchored" data-anchor-id="hybrid-search-in-lancedb">Hybrid Search in LanceDB</h3>
<pre class="{python}"><code># Sample hybrid search query
query = "What works best to improve health outcomes for displaced persons?"

query_embedding = get_text_embedding(query)
results = table.search(query_embedding).limit(5).to_list()

for result in results:
    print(result['metadata'])
    print(result['text'][:500])</code></pre>
<pre class="{python}"><code>def query_evidence(question: str, table: lancedb.db.LanceTable) -&gt; Dict:
    """Enhanced query with hybrid search and evidence grading"""
    try:
        # Hybrid search
        results = hybrid_search(table, question, limit=7)
        
        if results.empty:
            return {"answer": "No relevant evidence found.", "sources": []}
        
        context = "\n\n".join([
            f"Document {i+1} (Relevance: {row.get('combined_score', 0):.2f}):\n{row['text']}\n"
            for i, row in results.iterrows()
        ])
        
        # Evidence-based answer generation
        prompt = f"""
        You are an evidence specialist answering questions about IOM programs.
        Use ONLY the provided context from evaluation reports.
        For each claim in your answer, cite the document number it came from.
        
        Question: {question}
        
        Context:
        {context}
        
        Provide:
        1. A direct answer to the question
        2. Strength of evidence (High/Medium/Low)
        3. Any limitations or caveats
        4. List of sources with relevance scores
        """
        
        response = openai.ChatCompletion.create(
            engine=config.chat_model,
            messages=[{"role": "user", "content": prompt}],
            temperature=config.temperature,
            max_tokens=config.max_tokens
        )
        
        answer = response.choices[0].message.content
        sources = [
            {"url": url, "score": score}
            for url, score in zip(results['url'], results.get('combined_score', 0))
        ]
        
        return {
            "question": question,
            "answer": answer,
            "sources": sources,
            "search_scores": results[['_distance', '_score', 'combined_score']].to_dict()
        }
    
    except Exception as e:
        print(f"Query error: {str(e)}")
        return {"error": str(e)}
</code></pre>
<pre class="{python}"><code>def extract_structured_info(table, iom_framework):
    """Extract structured information from reports using the IOM Results Framework"""
    # Generate questions based on the IOM framework
    questions = generate_questions_from_framework(iom_framework)
    
    # Store extracted information
    extracted_data = []
    
    # Process each question
    for question in questions:
        print(f"Processing question: {question}")
        
        # Search for relevant chunks
        results = table.search(generate_embeddings([question])[0]).limit(10).to_pandas()
        
        # Combine relevant chunks as context
        context = "\n\n".join(results["text"].tolist())
        
        # Use Azure OpenAI to extract structured answer
        prompt = f"""
        Based on the following evaluation report excerpts, answer the question with structured information.
        Provide your answer in JSON format with the following structure:
        {{
            "question": "the question being asked",
            "answer": "the concise answer",
            "intervention_type": "type of intervention mentioned",
            "population": "target population mentioned",
            "outcome": "outcome measured",
            "geography": "geographic location if mentioned",
            "evidence_strength": "strength of evidence (high/medium/low)"
        }}

        Question: {question}
        Context: {context}
        """
        
        response = openai.ChatCompletion.create(
            engine=config["azure_openai_chat_deployment"],
            messages=[{"role": "user", "content": prompt}],
            temperature=config["temperature"],
            max_tokens=config["max_tokens"]
        )
        
        try:
            answer = json.loads(response.choices[0].message.content)
            answer["source_urls"] = results["url"].unique().tolist()
            extracted_data.append(answer)
        except json.JSONDecodeError:
            print(f"Failed to parse answer for question: {question}")
    
    return pd.DataFrame(extracted_data)

def generate_questions_from_framework(framework_df):
    """Generate questions based on the IOM Results Framework"""
    questions = []
    
    # Example questions based on common evaluation themes
    for _, row in framework_df.iterrows():
        questions.extend([
            f"What interventions has IOM implemented to achieve {row['Objective']}?",
            f"What evidence exists for the effectiveness of interventions targeting {row['Outcome']}?",
            f"What populations have been targeted by interventions aiming for {row['Indicator']}?",
            f"What geographic areas have seen interventions related to {row['Objective']}?",
            f"What methodologies have been used to evaluate interventions for {row['Outcome']}?"
        ])
    
    # Add some general evaluation questions
    questions.extend([
        "What are the most effective interventions for migrant livelihood improvement?",
        "What evidence exists for cash-based interventions in migration contexts?",
        "What are common challenges in implementing migration programs?",
        "What evaluation methodologies are most commonly used in IOM evaluations?",
        "What gaps exist in the evidence base for migration interventions?"
    ])
    
    return list(set(questions))  # Remove duplicates

def hybrid_search(table: lancedb.db.LanceTable, query: str, limit: int = 10) -&gt; pd.DataFrame:
    """Perform hybrid (vector + full-text) search"""
    # Generate query embedding
    query_embedding = generate_embeddings_batch([query])[0]
    
    # Perform hybrid search
    results = table.search(query_embedding, query_string=query)\
                 .limit(limit)\
                 .to_pandas()
    
    # Score normalization (simple example)
    if not results.empty:
        max_vector_score = results["_distance"].max()
        max_fts_score = results["_score"].max()
        
        if max_vector_score &gt; 0 and max_fts_score &gt; 0:
            results["combined_score"] = (
                0.7 * (results["_distance"] / max_vector_score) +
                0.3 * (results["_score"] / max_fts_score)
            )
            results = results.sort_values("combined_score", ascending=False)
    
    return results

def extract_structured_info(table: lancedb.db.LanceTable, iom_framework: pd.DataFrame) -&gt; pd.DataFrame:
    """Enhanced information extraction with hybrid search"""
    questions = generate_questions_from_framework(iom_framework)
    extracted_data = []
    
    for question in questions:
        try:
            # Hybrid search for relevant chunks
            results = hybrid_search(table, question, limit=15)
            
            if results.empty:
                continue
                
            context = "\n\n".join(results["text"].tolist())
            sources = results["url"].unique().tolist()
            
            # Structured extraction prompt
            prompt = f"""
            Extract structured information from this evaluation report context to answer the question.
            Return ONLY valid JSON with this structure:
            {{
                "question": "the question",
                "answer": "concise answer",
                "intervention_type": ["type1", "type2"],
                "population": ["group1", "group2"],
                "outcome": ["outcome1", "outcome2"],
                "geography": ["location1", "location2"],
                "evidence_strength": "high/medium/low",
                "source_urls": ["url1", "url2"]
            }}
            
            Question: {question}
            Context: {context}
            """
            
            response = openai.ChatCompletion.create(
                engine=config.chat_model,
                messages=[{"role": "user", "content": prompt}],
                temperature=config.temperature,
                max_tokens=config.max_tokens,
                response_format={ "type": "json_object" }
            )
            
            answer = json.loads(response.choices[0].message.content)
            answer["source_urls"] = sources
            extracted_data.append(answer)
            
        except Exception as e:
            print(f"Error processing question '{question}': {str(e)}")
            continue
    
    return pd.DataFrame(extracted_data)
</code></pre>
</section>
</section>
<section id="step-3-cross-evaluation-analysis" class="level2">
<h2 class="anchored" data-anchor-id="step-3-cross-evaluation-analysis">Step 3: Cross-Evaluation Analysis</h2>
</section>
<section id="step-4-generate-actionable-and-generalizable-insights" class="level2">
<h2 class="anchored" data-anchor-id="step-4-generate-actionable-and-generalizable-insights">Step 4: Generate Actionable and Generalizable Insights</h2>
<p>One key challenge is How to generalize the findings from an evaluation from one place to another one? The <a href="https://ssir.org/articles/entry/the_generalizability_puzzle">Generalizability Framework</a> provides some insights on how to do that.</p>
<p>To implement this we will generate insights using AI-enabled Q&amp;A on all previous Q&amp;A:</p>
<pre class="{python}"><code>def generate_insights(df):
    # Add your insight generation logic here
    return df

df = generate_insights(df)</code></pre>
</section>
<section id="step-5-identify-patterns-and-gaps" class="level2">
<h2 class="anchored" data-anchor-id="step-5-identify-patterns-and-gaps">Step 5: Identify Patterns and Gaps</h2>
<p>Identify patterns and gaps in the data:</p>
<pre class="{python}"><code>def identify_patterns(df):
    # Add your pattern identification logic here
    return df

df = identify_patterns(df)</code></pre>
<pre class="{python}"><code>def generate_deliverables(df):
    # Generate Q&amp;A dataset
    qa_dataset = df[['question', 'answer']]

    # Generate synthesis report
    synthesis_report = df.describe()

    # Generate visual evidence map
    plt.figure(figsize=(10, 6))
    sns.scatterplot(data=df, x='outcome', y='population', size='sample_size')
    plt.title('Visual Evidence Map')
    plt.show()

    return qa_dataset, synthesis_report

qa_dataset, synthesis_report = generate_deliverables(df)</code></pre>
<p>Visualize Patterns &amp; Gaps</p>
<pre class="{python}"><code># Convert QA to structured fields (intervention, outcome, population, etc.)
qa_df = pd.json_normalize(df_docs["qa"].apply(json.loads))

# Bubble Map Example
fig = px.scatter(qa_df, x="geography", y="outcome",
                 size="sample_size", color="intervention",
                 hover_name="file_name",
                 title="Evidence Bubble Map")
fig.show()

# Heatmap Example
heatmap_df = pd.crosstab(qa_df["intervention"], qa_df["outcome"])
sns.heatmap(heatmap_df, annot=True, cmap="coolwarm")</code></pre>
<pre class="{python}"><code>def create_interactive_visualizations(extracted_data: pd.DataFrame):
    """Enhanced visualization functions"""
    # Prepare data
    df = extracted_data.explode("source_urls")
    
    # Evidence Strength Distribution
    strength_dist = df['evidence_strength'].value_counts().reset_index()
    fig1 = px.bar(
        strength_dist,
        x='evidence_strength',
        y='count',
        title='Distribution of Evidence Strength'
    )
    
    # Interventions by Geography
    fig2 = px.treemap(
        df,
        path=['geography', 'intervention_type'],
        title='Interventions by Geographic Region'
    )
    
    # Evidence Timeline (if dates available)
    if 'date' in df.columns:
        fig3 = px.line(
            df.groupby('date').size().reset_index(name='count'),
            x='date',
            y='count',
            title='Evidence Publication Timeline'
        )
    else:
        fig3 = None
    
    return fig1, fig2, fig3
</code></pre>
<pre class="{python}"><code>def visualize_evidence_map(extracted_data):
    """Create interactive visualizations of the evidence map"""
    
    # Prepare data for visualization
    df = extracted_data.explode("source_urls")
    
    # Bubble map: Interventions by outcome and evidence strength
    fig1 = px.scatter(
        df, 
        x="outcome", 
        y="intervention_type", 
        size="evidence_strength",  # This would need to be mapped to numeric values
        color="population",
        hover_name="answer",
        title="Evidence Map: Interventions by Outcome and Population"
    )
    fig1.update_layout(height=800)
    
    # Heatmap: Evidence concentration by intervention and outcome
    heatmap_data = df.groupby(['intervention_type', 'outcome']).size().unstack().fillna(0)
    fig2 = px.imshow(
        heatmap_data,
        labels=dict(x="Outcome", y="Intervention Type", color="Number of Studies"),
        title="Evidence Concentration Heatmap"
    )
    
    # Gap map: Missing evidence
    all_interventions = df['intervention_type'].unique()
    all_outcomes = df['outcome'].unique()
    complete_grid = pd.MultiIndex.from_product([all_interventions, all_outcomes], names=['intervention_type', 'outcome'])
    gap_data = df.groupby(['intervention_type', 'outcome']).size().reindex(complete_grid, fill_value=0).reset_index()
    gap_data['has_evidence'] = gap_data[0] &gt; 0
    
    fig3 = px.scatter(
        gap_data,
        x="outcome",
        y="intervention_type",
        color="has_evidence",
        title="Evidence Gap Map (Red = Missing Evidence)"
    )
    
    return fig1, fig2, fig3

def generate_synthesis_report(extracted_data):
    """Generate a narrative synthesis report of findings"""
    prompt = f"""
    You are an evaluation specialist analyzing evidence from IOM evaluation reports.
    Below is structured data extracted from multiple evaluation reports:
    
    {extracted_data.to_json()}
    
    Write a comprehensive synthesis report that:
    1. Summarizes key findings across interventions
    2. Identifies areas with strong evidence
    3. Highlights evidence gaps
    4. Provides recommendations for future evaluations
    5. Suggests high-priority research areas
    
    Structure your report with clear sections and bullet points for readability.
    """
    
    response = openai.ChatCompletion.create(
        engine=config["azure_openai_chat_deployment"],
        messages=[{"role": "user", "content": prompt}],
        temperature=0.5,  # Slightly more creative for synthesis
        max_tokens=3000
    )
    
    return response.choices[0].message.content
</code></pre>
<p>Save the deliverables to files:</p>
<pre class="{python}"><code>qa_dataset.to_csv('qa_dataset.csv', index=False)
synthesis_report.to_csv('synthesis_report.csv')</code></pre>
</section>
<section id="conclusions---and-potential-extension" class="level2">
<h2 class="anchored" data-anchor-id="conclusions---and-potential-extension">Conclusions - and potential extension…</h2>
<ul>
<li><p>Web interface (Streamlit, Gradio, etc.)</p></li>
<li><p>Periodic syncing with new evaluations via web scraping</p></li>
<li><p>Integration with Hugging Face for fine-tuning a summarization or Q&amp;A model</p></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/iom\.github\.io\/evaluation_knowledge");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/iom/evaluation_knowledge/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>